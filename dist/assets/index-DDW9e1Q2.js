var $t=Object.defineProperty;var jt=(i,t,e)=>t in i?$t(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var o=(i,t,e)=>jt(i,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const h of n.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();var yt=[],Pt=class Dt{constructor(){this._bvh_parent=null,this._bvh_branch=!0,this._bvh_left=null,this._bvh_right=null,this._bvh_sort=0,this._bvh_min_x=0,this._bvh_min_y=0,this._bvh_max_x=0,this._bvh_max_y=0}static getBranch(){return yt.length?yt.pop():new Dt}static releaseBranch(t){yt.push(t)}static sortBranches(t,e){return t.sort>e.sort?-1:1}},Lt=class ht{constructor(){this._hierarchy=null,this._bodies=[],this._dirty_branches=[]}insert(t,e=!1){if(!e){let y=t._bvh;if(y&&y!==this)throw new Error("Body belongs to another collision system");t._bvh=this,this._bodies.push(t)}let s=t._polygon,r=t.x,n=t.y;s&&(t._dirty_coords||t.x!==t._x||t.y!==t._y||t.angle!==t._angle||t.scale_x!==t._scale_x||t.scale_y!==t._scale_y)&&t._calculateCoords();let h=t._bvh_padding,a=s?0:t.radius*t.scale,u=(s?t._min_x:r-a)-h,l=(s?t._min_y:n-a)-h,c=(s?t._max_x:r+a)+h,d=(s?t._max_y:n+a)+h;t._bvh_min_x=u,t._bvh_min_y=l,t._bvh_max_x=c,t._bvh_max_y=d;let g=this._hierarchy,_=0;if(!g)this._hierarchy=t;else{let y=0;for(;y++<ht.MAX_DEPTH;)if(g._bvh_branch){let p=g._bvh_left,C=p._bvh_min_y,x=p._bvh_max_x,S=p._bvh_max_y,R=u<p._bvh_min_x?u:p._bvh_min_x,b=l<C?l:C,T=c>x?c:x,M=d>S?d:S,k=(x-p._bvh_min_x)*(S-C),Q=(T-R)*(M-b)-k,N=g._bvh_right,L=N._bvh_min_x,B=N._bvh_min_y,Y=N._bvh_max_x,U=N._bvh_max_y,I=u<L?u:L,P=l<B?l:B,O=c>Y?c:Y,V=d>U?d:U,nt=(Y-L)*(U-B),J=(O-I)*(V-P)-nt;g._bvh_sort=_++,g._bvh_min_x=R<I?R:I,g._bvh_min_y=b<P?b:P,g._bvh_max_x=T>O?T:O,g._bvh_max_y=M>V?M:V,g=Q<=J?p:N}else{let p=g._bvh_parent,C=g._bvh_min_x,x=g._bvh_min_y,S=g._bvh_max_x,R=g._bvh_max_y,b=g._bvh_parent=t._bvh_parent=Pt.getBranch();b._bvh_parent=p,b._bvh_left=g,b._bvh_right=t,b._bvh_sort=_++,b._bvh_min_x=u<C?u:C,b._bvh_min_y=l<x?l:x,b._bvh_max_x=c>S?c:S,b._bvh_max_y=d>R?d:R,p?p._bvh_left===g?p._bvh_left=b:p._bvh_right=b:this._hierarchy=b;break}}}remove(t,e=!1){if(!e){let a=t._bvh;if(a&&a!==this)throw new Error("Body belongs to another collision system");t._bvh=null,this._bodies.splice(this._bodies.indexOf(t),1)}if(this._hierarchy===t){this._hierarchy=null;return}let s=t._bvh_parent;if(!s){console.error("The parent is not defined in the collision system.");return}let r=s._bvh_parent,n=s._bvh_left,h=n===t?s._bvh_right:n;if(h._bvh_parent=r,h._bvh_branch&&(h._bvh_sort=s._bvh_sort),r){r._bvh_left===s?r._bvh_left=h:r._bvh_right=h;let a=r,u=0;for(;a&&u++<ht.MAX_DEPTH;){let l=a._bvh_left,c=l._bvh_min_x,d=l._bvh_min_y,g=l._bvh_max_x,_=l._bvh_max_y,y=a._bvh_right,p=y._bvh_min_x,C=y._bvh_min_y,x=y._bvh_max_x,S=y._bvh_max_y;a._bvh_min_x=c<p?c:p,a._bvh_min_y=d<C?d:C,a._bvh_max_x=g>x?g:x,a._bvh_max_y=_>S?_:S,a=a._bvh_parent}}else this._hierarchy=h;Pt.releaseBranch(s)}update(){let t=this._bodies,e=t.length;for(let s=0;s<e;++s){let r=t[s],n=!1;if(!n&&r.padding!==r._bvh_padding&&(r._bvh_padding=r.padding,n=!0),!n){let h=r._polygon;h&&(r._dirty_coords||r.x!==r._x||r.y!==r._y||r.angle!==r._angle||r.scale_x!==r._scale_x||r.scale_y!==r._scale_y)&&r._calculateCoords();let a=r.x,u=r.y,l=h?0:r.radius*r.scale,c=h?r._min_x:a-l,d=h?r._min_y:u-l,g=h?r._max_x:a+l,_=h?r._max_y:u+l;n=c<r._bvh_min_x||d<r._bvh_min_y||g>r._bvh_max_x||_>r._bvh_max_y}n&&(this.remove(r,!0),this.insert(r,!0))}}potentials(t){let e=[],s=t._bvh_min_x,r=t._bvh_min_y,n=t._bvh_max_x,h=t._bvh_max_y,a=this._hierarchy,u=!0;if(!a||!a._bvh_branch)return e;let l=0;for(;a&&l++<ht.MAX_DEPTH;){if(u){u=!1;let g=a._bvh_branch?a._bvh_left:null;for(;g&&g._bvh_max_x>=s&&g._bvh_max_y>=r&&g._bvh_min_x<=n&&g._bvh_min_y<=h;)a=g,g=a._bvh_branch?a._bvh_left:null}let c=a._bvh_branch,d=c?a._bvh_right:null;if(d&&d._bvh_max_x>s&&d._bvh_max_y>r&&d._bvh_min_x<n&&d._bvh_min_y<h)a=d,u=!0;else{!c&&a!==t&&e.push(a);let g=a._bvh_parent;if(g){for(;g&&g._bvh_right===a;)a=g,g=a._bvh_parent;a=g}else break}}return e}draw(t){let e=this._bodies,s=e.length;for(let r=0;r<s;++r)e[r].draw(t)}drawBVH(t){let e=this._hierarchy,s=!0;for(;e;){if(s){s=!1;let c=e._bvh_branch?e._bvh_left:null;for(;c;)e=c,c=e._bvh_branch?e._bvh_left:null}let r=e._bvh_branch,n=e._bvh_min_x,h=e._bvh_min_y,a=e._bvh_max_x,u=e._bvh_max_y,l=r?e._bvh_right:null;if(t.moveTo(n,h),t.lineTo(a,h),t.lineTo(a,u),t.lineTo(n,u),t.lineTo(n,h),l)e=l,s=!0;else{let c=e._bvh_parent;if(c){for(;c&&c._bvh_right===e;)e=c,c=e._bvh_parent;e=c}else break}}}};Lt.MAX_DEPTH=1e4;var Kt=Lt;function Yt(i,t,e=null,s=!0){let r=i._polygon,n=t._polygon,h=!1;return e&&(e.a=i,e.b=t,e.a_in_b=!0,e.b_in_a=!0,e.overlap=null,e.overlap_x=0,e.overlap_y=0,e.collidedSprite=null),r&&(i._dirty_coords||i.x!==i._x||i.y!==i._y||i.angle!==i._angle||i.scale_x!==i._scale_x||i.scale_y!==i._scale_y)&&i._calculateCoords(),n&&(t._dirty_coords||t.x!==t._x||t.y!==t._y||t.angle!==t._angle||t.scale_x!==t._scale_x||t.scale_y!==t._scale_y)&&t._calculateCoords(),(!s||qt(i,t))&&(r&&i._dirty_normals&&i._calculateNormals(),n&&t._dirty_normals&&t._calculateNormals(),h=r&&n?Jt(i,t,e):r?Nt(i,t,e,!1):n?Nt(t,i,e,!0):Zt(i,t,e)),e&&(e.collision=h),h}function qt(i,t){let e=i._polygon,s=e?0:i.x,r=e?0:i.y,n=e?0:i.radius*i.scale,h=e?i._min_x:s-n,a=e?i._min_y:r-n,u=e?i._max_x:s+n,l=e?i._max_y:r+n,c=t._polygon,d=c?0:t.x,g=c?0:t.y,_=c?0:t.radius*t.scale,y=c?t._min_x:d-_,p=c?t._min_y:g-_,C=c?t._max_x:d+_,x=c?t._max_y:g+_;return h<C&&a<x&&u>y&&l>p}function Jt(i,t,e=null){let s=i._coords.length,r=t._coords.length;if(s===2&&r===2){let l=i._coords,c=t._coords;return e&&(e.overlap=0),l[0]===c[0]&&l[1]===c[1]}let n=i._coords,h=t._coords,a=i._normals,u=t._normals;if(s>2){for(let l=0,c=1;l<s;l+=2,c+=2)if(Bt(n,h,a[l],a[c],e))return!1}if(r>2){for(let l=0,c=1;l<r;l+=2,c+=2)if(Bt(n,h,u[l],u[c],e))return!1}return!0}function Nt(i,t,e=null,s=!1){let r=i._coords,n=i._edges,h=i._normals,a=t.x,u=t.y,l=t.radius*t.scale,c=l*2,d=l*l,g=r.length,_=!0,y=!0,p=null,C=0,x=0;if(g===2){let S=a-r[0],R=u-r[1],b=S*S+R*R;if(b>d)return!1;if(e){let T=Math.sqrt(b);p=l-T,C=S/T,x=R/T,y=!1}}else for(let S=0,R=1;S<g;S+=2,R+=2){let b=a-r[S],T=u-r[R],M=n[S],k=n[R],Q=b*M+T*k,N=Q<0?-1:Q>M*M+k*k?1:0,L=!1,B=0,Y=0,U=0;if(e&&_&&b*b+T*T>d&&(_=!1),N){let I=N===-1,P=I?S===0?g-2:S-2:S===g-2?0:S+2,O=P+1,V=a-r[P],nt=u-r[O],J=n[P],mt=n[O],kt=V*J+nt*mt;if((kt<0?-1:kt>J*J+mt*mt?1:0)===-N){let pt=I?b:V,_t=I?T:nt,It=pt*pt+_t*_t;if(It>d)return!1;if(e){let ft=Math.sqrt(It);L=!0,B=l-ft,Y=pt/ft,U=_t/ft,y=!1}}}else{let I=h[S],P=h[R],O=b*I+T*P,V=O<0?-O:O;if(O>0&&V>l)return!1;e&&(L=!0,B=l-O,Y=I,U=P,(y&&O>=0||B<c)&&(y=!1))}L&&(p===null||p>B)&&(p=B,C=Y,x=U)}return e&&(e.a_in_b=s?y:_,e.b_in_a=s?_:y,e.overlap=p,e.overlap_x=s?-C:C,e.overlap_y=s?-x:x),!0}function Zt(i,t,e=null){let s=i.radius*i.scale,r=t.radius*t.scale,n=t.x-i.x,h=t.y-i.y,a=s+r,u=n*n+h*h;if(u>a*a)return!1;if(e){let l=Math.sqrt(u);e.a_in_b=s<=r&&l<=r-s,e.b_in_a=r<=s&&l<=s-r,e.overlap=a-l,e.overlap_x=n/l,e.overlap_y=h/l}return!0}function Bt(i,t,e,s,r=null){let n=i.length,h=t.length;if(!n||!h)return!0;let a=null,u=null,l=null,c=null;for(let d=0,g=1;d<n;d+=2,g+=2){let _=i[d]*e+i[g]*s;(a===null||a>_)&&(a=_),(u===null||u<_)&&(u=_)}for(let d=0,g=1;d<h;d+=2,g+=2){let _=t[d]*e+t[g]*s;(l===null||l>_)&&(l=_),(c===null||c<_)&&(c=_)}if(a>c||u<l)return!0;if(r){let d=0;if(a<l)if(r.a_in_b=!1,u<c)d=u-l,r.b_in_a=!1;else{let y=u-l,p=c-a;d=y<p?y:-p}else if(r.b_in_a=!1,u>c)d=a-c,r.a_in_b=!1;else{let y=u-l,p=c-a;d=y<p?y:-p}let g=r.overlap,_=d<0?-d:d;if(g===null||g>_){let y=d<0?-1:1;r.overlap=_,r.overlap_x=e*y,r.overlap_y=s*y}}return!1}var et=class{constructor(){this.collision=!1,this.a=null,this.b=null,this.a_in_b=!1,this.b_in_a=!1,this.overlap=0,this.overlap_x=0,this.overlap_y=0}},Ut=class{constructor(i=0,t=0,e=5){this._offset_x=0,this._offset_y=0,this._circle=!1,this._polygon=!1,this._point=!1,this._bvh=null,this._bvh_parent=null,this._bvh_branch=!1,this._bvh_min_x=0,this._bvh_min_y=0,this._bvh_max_x=0,this._bvh_max_y=0,this._parent_sprite=null,this._center_distance=0,this._center_angle=0,this.x=i,this.y=t,this.padding=e,this._bvh_padding=e}collides(i,t=null,e=!0){return Yt(this,i,t,e)}potentials(){let i=this._bvh;if(i===null)throw new Error("Body does not belong to a collision system");return i.potentials(this)}remove(){let i=this._bvh;i&&i.remove(this,!1)}set parentSprite(i){this._parent_sprite=i}get parentSprite(){return this._parent_sprite}set offset_x(i){this._offset_x=-i,this.updateCenterParams()}get offset_x(){return-this._offset_x}set offset_y(i){this._offset_y=-i,this.updateCenterParams()}get offset_y(){return-this._offset_y}get center_offset_x(){if(this._parent_sprite.rotateStyle==="leftRight"||this._parent_sprite.rotateStyle==="none"){let i=this._parent_sprite._direction>180&&this._parent_sprite.rotateStyle==="leftRight"?-1:1;return this._offset_x*i}return this._center_distance*Math.cos(this._center_angle-this._parent_sprite.globalAngleRadians)}get center_offset_y(){return this._parent_sprite.rotateStyle==="leftRight"||this._parent_sprite.rotateStyle==="none"?-this._offset_y:-this._center_distance*Math.sin(this._center_angle-this._parent_sprite.globalAngleRadians)}createResult(){return new et}updateCenterParams(){this._center_distance=Math.hypot(this._offset_x,this._offset_y),this._center_angle=-Math.atan2(-this._offset_y,-this._offset_x)}static createResult(){return new et}},lt=class extends Ut{constructor(i=0,t=0,e=0,s=1,r=5){super(i,t,r),this.radius=e,this.scale=s}draw(i){let t=this.x,e=this.y,s=this.radius*this.scale;i.moveTo(t+s,e),i.arc(t,e,s,0,Math.PI*2)}},z=class Vt extends Ut{constructor(t=0,e=0,s=[],r=0,n=1,h=1,a=5){super(t,e,a),this._min_x=0,this._min_y=0,this._max_x=0,this._max_y=0,this._points=null,this._coords=null,this._edges=null,this._normals=null,this._dirty_coords=!0,this._dirty_normals=!0,this._origin_points=null,this.angle=r,this.scale_x=n,this.scale_y=h,this._polygon=!0,this._x=t,this._y=e,this._angle=r,this._scale_x=n,this._scale_y=h,this._origin_points=s,Vt.prototype.setPoints.call(this,s)}draw(t){(this._dirty_coords||this.x!==this._x||this.y!==this._y||this.angle!==this._angle||this.scale_x!==this._scale_x||this.scale_y!==this._scale_y)&&this._calculateCoords();let e=this._coords;if(e.length===2)t.moveTo(e[0],e[1]),t.arc(e[0],e[1],1,0,Math.PI*2);else{t.moveTo(e[0],e[1]);for(let s=2;s<e.length;s+=2)t.lineTo(e[s],e[s+1]);e.length>4&&t.lineTo(e[0],e[1])}}setPoints(t){let e=t.length;this._points=new Float64Array(e*2),this._coords=new Float64Array(e*2),this._edges=new Float64Array(e*2),this._normals=new Float64Array(e*2);let s=this._points;for(let r=0,n=0,h=1;r<e;++r,n+=2,h+=2){let a=t[r];s[n]=a[0],s[h]=a[1]}this._dirty_coords=!0}_calculateCoords(){let t=this.x,e=this.y,s=this.angle,r=this.scale_x,n=this.scale_y,h=this._points,a=this._coords,u=h.length,l,c,d,g;for(let _=0,y=1;_<u;_+=2,y+=2){let p=h[_]*r,C=h[y]*n;if(s){let x=Math.cos(s),S=Math.sin(s),R=p,b=C;p=R*x-b*S,C=R*S+b*x}p+=t,C+=e,a[_]=p,a[y]=C,_===0?(l=c=p,d=g=C):(p<l?l=p:p>c&&(c=p),C<d?d=C:C>g&&(g=C))}this._x=t,this._y=e,this._angle=s,this._scale_x=r,this._scale_y=n,this._min_x=l,this._min_y=d,this._max_x=c,this._max_y=g,this._dirty_coords=!1,this._dirty_normals=!0}_calculateNormals(){let t=this._coords,e=this._edges,s=this._normals,r=t.length;for(let n=0,h=1;n<r;n+=2,h+=2){let a=n+2<r?n+2:0,u=t[a]-t[n],l=t[a+1]-t[h],c=u||l?Math.sqrt(u*u+l*l):0;e[n]=u,e[h]=l,s[n]=c?l/c:0,s[h]=c?-u/c:0}this._dirty_normals=!1}get points(){return this._origin_points}},xt=class extends z{constructor(i=0,t=0,e=5){super(i,t,[[0,0]],0,1,1,e),this._point=!0}};xt.prototype.setPoints=void 0;var te=class{constructor(){this._bvh=new Kt}createCircle(i=0,t=0,e=0,s=1,r=0){let n=new lt(i,t,e,s,r);return this._bvh.insert(n),n}createPolygon(i=0,t=0,e=[[0,0]],s=0,r=1,n=1,h=0){let a=new z(i,t,e,s,r,n,h);return this._bvh.insert(a),a}createPoint(i=0,t=0,e=0){let s=new xt(i,t,e);return this._bvh.insert(s),s}createResult(){return new et}static createResult(){return new et}insert(...i){for(let t of i)this._bvh.insert(t,!1);return this}remove(...i){for(let t of i)this._bvh.remove(t,!1);return this}update(){return this._bvh.update(),this}draw(i){return this._bvh.draw(i)}drawBVH(i){return this._bvh.drawBVH(i)}potentials(i){return this._bvh.potentials(i)}collides(i,t,e=null,s=!0){return Yt(i,t,e,s)}},w=class Z{static getMessage(t,e,s=null){if(!Z.messages[t])throw new Error("Message is not defined.");if(!Z.messages[t][e])throw new Error("Message for this locale is not defined.");let r=Z.messages[t][e];return s&&(r=Z.replaceVariables(r,s)),r}static replaceVariables(t,e){return t.replace(/\${([^}]+)}/g,(s,r)=>e[r]!==void 0?e[r]:"")}};w.SCRIPT_ERROR="script_error",w.MISTAKE_METHOD="mistake_method",w.MISTAKE_METHOD_WITH_CLOSEST="mistake_method_with_closest",w.NEED_STAGE_BEFORE_RUN_GAME="need_stage_before_run_game",w.NEED_CREATE_STAGE_BEFORE_SPRITE="need_create_stage_before_sprite",w.COSTUME_NOT_LOADED="costume_not_loaded",w.BACKGROUND_NOT_LOADED="background_not_loaded",w.CLONED_NOT_READY="cloned_not_ready",w.SOUND_INDEX_NOT_FOUND="sound_index_not_found",w.SOUND_NAME_NOT_FOUND="sound_name_not_found",w.SOUND_NAME_ALREADY_EXISTS="sound_name_already_exists",w.SOUND_NOT_ALLOWED_ERROR="sound_not_allowed_error",w.SOUND_USE_NOT_READY="sound_use_not_ready",w.COSTUME_INDEX_NOT_FOUND="costume_index_not_found",w.COSTUME_NAME_NOT_FOUND="costume_name_not_found",w.COSTUME_SWITCH_NOT_READY="costume_switch_not_ready",w.STAMP_NOT_READY="stamp_not_ready",w.STAMP_COSTUME_NOT_FOUND="stamp_costume_not_found",w.COLLIDER_NAME_NOT_FOUND="collider_name_not_found",w.STAGE_SET_BEFORE_GAME_READY="stage_set_before_game_ready",w.messages={script_error:{ru:"Произошла ошибка, ознакомьтесь с подробной информацией в консоли.",en:"An error has occurred, take a look at the details in the console."},mistake_method:{ru:'${className}: Метод или свойство "${prop}" не найдено',en:'${className}: Method "${prop}" not found'},mistake_method_with_closest:{ru:'${className}: Метод или свойство "${prop}" не найдено. Возможно вы имели ввиду: ${closestString}?',en:'${className}: Method "${prop}" not found. Did you mean: ${closestString}?'},need_stage_before_run_game:{ru:"Вам нужно создать экземпляр Stage перед запуском игры.",en:"You need create Stage instance before run game."},need_create_stage_before_sprite:{ru:"Вам нужно создать экземпляр класса Stage перед экземпляром класса Sprite.",en:"You need create Stage instance before Sprite instance."},costume_not_loaded:{ru:'Изображение для костюма "${costumePath}" не было загружено. Проверьте правильность пути.',en:'Costume image "${costumePath}" was not loaded. Check that the path is correct.'},background_not_loaded:{ru:'Изображение для фона "${backgroundPath}" не было загружено. Проверьте правильность пути.',en:'Background image "${backgroundPath}" was not loaded. Check that the path is correct.'},cloned_not_ready:{ru:"Спрайт не может быть клонирован, потому что он еще не готов. Попробуйте использовать метод sprite.onReady()",en:"Sprite cannot be cloned because one is not ready. Try using the sprite.onReady() method."},sound_index_not_found:{ru:'Звук с индексом "${soundIndex}" не найден.',en:'Sound with index "${soundIndex}" not found.'},sound_name_not_found:{ru:'Звук с именем "${soundName}" не найден.',en:'Sound with name "${soundName}" not found.'},sound_name_already_exists:{ru:'Звук с именем "${soundName}" уже добавлен.',en:'Sound with name "${soundName}" already exists.'},sound_use_not_ready:{ru:"Спрайт не может использовать звуки, потому что спрайт еще не готов. Попробуйте использовать метод sprite.onReady().",en:"Sprite cannot use sounds because sprite is not ready. Try using the sprite.onReady() method."},sound_not_allowed_error:{ru:"Воспроизведение звука заблокировано. Пользователь должен сначала взаимодействовать с игрой. Воспользуйтесь методом Game.onUserInteracted()",en:"Audio playback is blocked. The user must first interact with the game. Use the Game.onUserInteracted() method."},costume_index_not_found:{ru:'Костюм с индексом "${costumeIndex}" не найден.',en:'Costume with index "${costumeIndex}" not found.'},costume_name_not_found:{ru:'Костюм с именем "${costumeName}" не найден.',en:'Costume with name "${costumeName}" not found.'},costume_switch_not_ready:{ru:"Спрайт не может изменить костюм, потому что спрайт еще не готов. Попробуйте использовать метод sprite.onReady().",en:"Sprite cannot change a costume because sprite is not ready. Try using the sprite.onReady() method."},stamp_not_ready:{ru:"Спрайт не может создать штамп, потому что он еще не готов. Попробуйте использовать метод sprite.onReady()",en:"Sprite cannot create a stamp because sprite is not ready. Try using the sprite.onReady() method."},stamp_costume_not_found:{ru:'Штам не может быть создан, так как костюм с индексом "${costumeIndex}" не найден.',en:'The stamp cannot be created because the costume with the index "${costumeIndex}" has not been found.'},collider_name_not_found:{ru:'Коллайдер с именем "${colliderName}" не найден.',en:'Collider with name "${colliderName}" not found.'},stage_set_before_game_ready:{ru:"Спрайт меняет сцену до готовности игры.",en:"Sprite changed stage before game is ready."}};var E=w,Qt=class zt{static getChar(t){return zt.map[t]}};Qt.map=["","","","CANCEL","","","HELP","","BACK_SPACE","TAB","","","CLEAR","ENTER","ENTER_SPECIAL","","SHIFT","CONTROL","ALT","PAUSE","CAPS_LOCK","KANA","EISU","JUNJA","FINAL","HANJA","","ESCAPE","CONVERT","NONCONVERT","ACCEPT","MODECHANGE","SPACE","PAGE_UP","PAGE_DOWN","END","HOME","LEFT","UP","RIGHT","DOWN","SELECT","PRINT","EXECUTE","PRINTSCREEN","INSERT","DELETE","","0","1","2","3","4","5","6","7","8","9","COLON","SEMICOLON","LESS_THAN","EQUALS","GREATER_THAN","QUESTION_MARK","AT","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","OS_KEY","","CONTEXT_MENU","","SLEEP","NUMPAD0","NUMPAD1","NUMPAD2","NUMPAD3","NUMPAD4","NUMPAD5","NUMPAD6","NUMPAD7","NUMPAD8","NUMPAD9","MULTIPLY","ADD","SEPARATOR","SUBTRACT","DECIMAL","DIVIDE","F1","F2","F3","F4","F5","F6","F7","F8","F9","F10","F11","F12","F13","F14","F15","F16","F17","F18","F19","F20","F21","F22","F23","F24","","","","","","","","","NUM_LOCK","SCROLL_LOCK","WIN_OEM_FJ_JISHO","WIN_OEM_FJ_MASSHOU","WIN_OEM_FJ_TOUROKU","WIN_OEM_FJ_LOYA","WIN_OEM_FJ_ROYA","","","","","","","","","","CIRCUMFLEX","EXCLAMATION","DOUBLE_QUOTE","HASH","DOLLAR","PERCENT","AMPERSAND","UNDERSCORE","OPEN_PAREN","CLOSE_PAREN","ASTERISK","PLUS","PIPE","HYPHEN_MINUS","OPEN_CURLY_BRACKET","CLOSE_CURLY_BRACKET","TILDE","","","","","VOLUME_MUTE","VOLUME_DOWN","VOLUME_UP","","","SEMICOLON","EQUALS","COMMA","MINUS","PERIOD","SLASH","BACK_QUOTE","","","","","","","","","","","","","","","","","","","","","","","","","","","OPEN_BRACKET","BACK_SLASH","CLOSE_BRACKET","QUOTE","","META","ALTGR","","WIN_ICO_HELP","WIN_ICO_00","","WIN_ICO_CLEAR","","","WIN_OEM_RESET","WIN_OEM_JUMP","WIN_OEM_PA1","WIN_OEM_PA2","WIN_OEM_PA3","WIN_OEM_WSCTRL","WIN_OEM_CUSEL","WIN_OEM_ATTN","WIN_OEM_FINISH","WIN_OEM_COPY","WIN_OEM_AUTO","WIN_OEM_ENLW","WIN_OEM_BACKTAB","ATTN","CRSEL","EXSEL","EREOF","PLAY","ZOOM","","PA1","WIN_OEM_CLEAR",""];var at=Qt,ee=class{constructor(){this.keys={},document.addEventListener("keydown",i=>{let t=at.getChar(i.keyCode);this.keys[t]=!0}),document.addEventListener("keyup",i=>{let t=at.getChar(i.keyCode);delete this.keys[t]})}keyPressed(i){return this.keys[i.toUpperCase()]!==void 0}keyDown(i,t){document.addEventListener("keydown",e=>{let s=at.getChar(e.keyCode);i.toUpperCase()==s&&t(e)})}keyUp(i,t){document.addEventListener("keyup",e=>{let s=at.getChar(e.keyCode);i.toUpperCase()==s&&t(e)})}},ie=class{constructor(i){this.x=0,this.y=0,this.isDown=!1,document.addEventListener("mousedown",()=>{this.isDown=!0,this.lastStage=i.getActiveStage()}),document.addEventListener("mouseup",()=>{this.isDown=!1}),document.addEventListener("mousemove",t=>{this.x=i.correctMouseX(t.clientX),this.y=i.correctMouseY(t.clientY)}),this.point=new xt(this.x,this.y)}getPoint(){return this.point.x=this.x,this.point.y=this.y,this.point}isMouseDown(i){return this.isDown&&i===this.lastStage}clearMouseDown(){this.isDown=!1}},it=class Ft{constructor(){this.data={}}static getInstance(){return this.instance||(this.instance=new Ft),this.instance}set(t,e){this.data[t]=e}has(t){return this.data[t]!==void 0}get(t){return this.data[t]}},se=class{constructor(i,t,e){this.canvas=i,this.setEnvironmentStyles(),this.setCanvasSize(t,e),this.canvasRect=i.getBoundingClientRect(),window.addEventListener("resize",()=>{this.setCanvasSize(t,e),this.canvasRect=i.getBoundingClientRect()})}setEnvironmentStyles(){document.body.style.margin="0",document.body.style.height="100vh",document.body.style.padding="0",document.body.style.overflow="hidden",document.body.style.display="flex",document.body.style.alignItems="center",document.body.style.justifyContent="center"}setCanvasSize(i,t){this.canvas.width=i||document.body.clientWidth,this.canvas.height=t||document.body.clientHeight}},re=class Ct{constructor(t){this.game=t}createValidator(t,e){let s=this.game;return new Proxy(t,{get(r,n){if(n in r)return r[n];if(typeof n=="symbol"||n.startsWith("_"))return;let h=Object.getOwnPropertyNames(Object.getPrototypeOf(r)).filter(u=>u!=="constructor"),a=Ct.findClosestMethods(n.toString(),h);if(a.length){let u=a.join(", ");s.throwError(E.MISTAKE_METHOD_WITH_CLOSEST,{className:e,prop:n,closestString:u})}else s.throwError(E.MISTAKE_METHOD,{className:e,prop:n})}})}static findClosestMethods(t,e,s=2){return e.map(r=>({name:r,distance:Ct.levenshteinDistance(t.toLowerCase(),r.toLowerCase())})).filter(({distance:r})=>r<=s).sort((r,n)=>r.distance-n.distance).map(({name:r})=>r).slice(0,3)}static levenshteinDistance(t,e){let s=Array(t.length+1).fill(null).map(()=>Array(e.length+1).fill(0));for(let r=0;r<=t.length;r++)s[r][0]=r;for(let r=0;r<=e.length;r++)s[0][r]=r;for(let r=1;r<=t.length;r++)for(let n=1;n<=e.length;n++){let h=t[r-1]===e[n-1]?0:1;s[r][n]=Math.min(s[r-1][n]+1,s[r][n-1]+1,s[r-1][n-1]+h)}return s[t.length][e.length]}},ot=class{constructor(){this.ready=!1}get width(){return this.image instanceof HTMLCanvasElement?this.image.width:0}get height(){return this.image instanceof HTMLCanvasElement?this.image.height:0}},Rt=class{constructor(){this.callbacksMap=new Map,this.eventTarget=new EventTarget}once(i,t,e){if(this.callbacksMap.get(i))return!1;let s=r=>{typeof e=="function"?e(r):e.handleEvent(r),this.eventTarget.removeEventListener(t,s),this.remove(i)};return this.eventTarget.addEventListener(t,s),this.callbacksMap.set(i,{type:t,callback:s}),!0}on(i,t,e){return this.callbacksMap.get(i)?!1:(this.eventTarget.addEventListener(t,e),this.callbacksMap.set(i,{type:t,callback:e}),!0)}emit(i,t){this.eventTarget.dispatchEvent(new CustomEvent(i,{detail:t}))}remove(i){let t=this.callbacksMap.get(i);return t?(this.eventTarget.removeEventListener(t.type,t.callback),this.callbacksMap.delete(i),!0):!1}removeByType(i){this.callbacksMap.forEach((t,e)=>{i===t.type&&(this.eventTarget.removeEventListener(t.type,t.callback),this.callbacksMap.delete(e))})}clearAll(){this.callbacksMap.forEach(i=>{this.eventTarget.removeEventListener(i.type,i.callback)}),this.callbacksMap.clear()}},ut=class St{constructor(t=null,e=null,s=null,r=!0,n="ru",h=!1){this.debugMode="none",this.debugCollider=!1,this.debugColor="red",this.stages=[],this.activeStage=null,this.styles=null,this.loadedStages=0,this.onReadyCallbacks=[],this.onUserInteractedCallbacks=[],this.onReadyPending=!0,this.running=!1,this.pendingRun=!1,this.reportedError=!1,this._displayErrors=!0,this._locale="ru",this._userInteracted=!1,this._displayErrors=r,this._locale=n,this.validatorFactory=new re(this);let a=this;if(this.displayErrors&&(a=this.validatorFactory.createValidator(this,"Game")),window.onerror=()=>{a.reportError(E.getMessage(E.SCRIPT_ERROR,a._locale))},a.id=Symbol(),a.eventEmitter=new Rt,a.keyboard=new ee,s){let u=document.getElementById(s);u instanceof HTMLCanvasElement&&(a.canvas=u)}else a.canvas=document.createElement("canvas"),document.body.appendChild(a.canvas);return a.canvas.width=t,a.canvas.height=e,a.styles=new se(a.canvas,t,e),a.mouse=new ie(a),a.context=a.canvas.getContext("2d"),a.context.imageSmoothingEnabled=h,it.getInstance().set("game",a),a.addListeners(),a}addStage(t){return this.stages.push(t),this}getLastStage(){return this.stages.length?this.stages[this.stages.length-1]:null}getActiveStage(){return this.activeStage?this.activeStage:null}run(t=null){if(!(this.activeStage&&this.activeStage==t)){if(!t&&this.stages.length&&(t=this.stages[0]),t||this.throwError(E.NEED_STAGE_BEFORE_RUN_GAME),!this.running)for(let e of this.stages)e.ready();this.activeStage&&this.activeStage.running&&this.activeStage.stop(),this.running=!1,this.pendingRun=!0,this.activeStage=t,this.tryDoRun()}}isReady(){return this.loadedStages==this.stages.length}onReady(t){this.onReadyCallbacks.push(t)}onUserInteracted(t){this.onUserInteractedCallbacks.push(t)}stop(){this.activeStage&&this.activeStage.running&&this.activeStage.stop(),this.running=!1}get displayErrors(){return this._displayErrors}get locale(){return this._locale}get width(){return this.canvas.width}get height(){return this.canvas.height}get userInteracted(){return this._userInteracted}isInsideGame(t,e){return t>=0&&t<=this.width&&e>=0&&e<=this.height}correctMouseX(t){let e=this.activeStage?this.activeStage.camera.startCornerX:0;return t-this.styles.canvasRect.left+e}correctMouseY(t){let e=this.activeStage?this.activeStage.camera.startCornerY:0;return t-this.styles.canvasRect.top+e}keyPressed(t){if(Array.isArray(t)){for(let e of t)if(this.keyboard.keyPressed(e))return!0;return!1}return this.keyboard.keyPressed(t)}keyDown(t,e){this.keyboard.keyDown(t,e)}keyUp(t,e){this.keyboard.keyUp(t,e)}mouseDown(){return this.mouse.isMouseDown(this.activeStage)}mouseDownOnce(){let t=this.mouse.isMouseDown(this.activeStage);return this.mouse.clearMouseDown(),t}getMousePoint(){return this.mouse.getPoint()}getRandom(t,e){return Math.floor(Math.random()*(e-t+1))+t}throwError(t,e=null,s=!0){let r=E.getMessage(t,this.locale,e);this.throwErrorRaw(r,s)}throwErrorRaw(t,e=!0){throw e&&this.reportError(t),new Error(t)}reportError(t){this._displayErrors&&!this.reportedError&&(alert(t),this.reportedError=!0)}addListeners(){this.eventEmitter.on(St.STAGE_READY_EVENT,St.STAGE_READY_EVENT,t=>{this.loadedStages++,this.tryDoOnReady()}),document.addEventListener("visibilitychange",()=>{document.hidden?this.activeStage&&this.activeStage.running&&this.activeStage.stop():this.activeStage&&this.activeStage.stopped&&this.activeStage.run()}),this.userInteractionPromise=new Promise(t=>{document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",e=>{["Control","Shift","CapsLock","NumLock","Alt","Meta"].includes(e.key)||t(!0)},{once:!0})})}tryDoOnReady(){if(this.isReady()&&this.onReadyPending){if(this.onReadyPending=!1,this.onReadyCallbacks.length){for(let t of this.onReadyCallbacks)t();this.onReadyCallbacks=[]}this.userInteractionPromise.then(()=>{this._userInteracted=!0,this.onUserInteractedCallbacks.filter(t=>(t(this),!1))}),this.tryDoRun()}}tryDoRun(){this.pendingRun&&!this.running&&this.isReady()&&(this.running=!0,this.pendingRun=!1,this.activeStage.run())}};ut.STAGE_READY_EVENT="scrubjs.stage.ready",ut.STAGE_BACKGROUND_READY_EVENT="scrubjs.stage.background_ready",ut.SPRITE_READY_EVENT="scrubjs.sprite.ready";var tt=ut,ct=class{constructor(i,t,e,s){this.callback=i,this.state=t,this.timeout=e,this.finishCallback=s}},dt=class{constructor(i,t,e){this.interval=i,this.maxIterations=t,this.currentIteration=e}},v=class{constructor(i,t=0,e=[],s=null){if(this.name="No name",this.game=null,this.stage=null,this._parentSprite=null,this._collidedSprite=null,this._original=null,this.costumeIndex=null,this.costume=null,this.costumes=[],this.costumeNames=[],this.sounds=[],this.soundNames=[],this.currentColliderName=null,this.colliders=new Map,this.phrase=null,this.phraseLiveTime=null,this._x=0,this._y=0,this._pivotOffsetX=0,this._pivotOffsetY=0,this._width=0,this._height=0,this._defaultColliderNone=!1,this._direction=0,this._size=100,this._centerDistance=0,this._centerAngle=0,this._rotateStyle="normal",this._hidden=!1,this._opacity=null,this._filter=null,this._deleted=!1,this._stopped=!0,this.pendingCostumeGrids=0,this.pendingCostumes=0,this.pendingSounds=0,this._children=[],this.onReadyCallbacks=[],this.onReadyPending=!0,this.scheduledCallbacks=[],this.tempScheduledCallbacks=[],this._drawings=[],this._tags=[],this.stoppedTime=null,this.diffTime=null,!it.getInstance().has("game"))throw new Error("You need create Game instance before Stage instance.");this.game=it.getInstance().get("game");let r=this;this.game.displayErrors&&(r=this.game.validatorFactory.createValidator(this,"Sprite")),r.id=Symbol(),r.eventEmitter=new Rt,r.collisionResult=new et,r.stage=i,this.stage||(r.stage=this.game.getLastStage()),r.stage||r.game.throwError(E.STAGE_SET_BEFORE_GAME_READY),r._layer=t,r._x=r.game.width/2,r._y=r.game.height/2;for(let n of e)r.addCostume(n);return r.scheduledCallbackExecutor=new Xt(r),r.stage.addSprite(r),s?this.setOriginal(s):r.init(),r.stoppedTime=Date.now(),r}init(){}onReady(i){this.onReadyCallbacks.push(i)}isReady(){return this.pendingCostumes===0&&this.pendingCostumeGrids===0&&this.pendingSounds===0||this.game.isReady()}get deleted(){return this._deleted}get stopped(){return this._stopped}setParent(i){return i.addChild(this),this}addChild(i){if(!this._children.includes(i)){this._children.push(i),i.parent=this,i.layer=this.layer,i.x=0,i.y=0,i.direction=0;for(let t of this.tags)i.addTag(t)}return i.parent=this,this}removeChild(i){let t=this._children.indexOf(i);if(t>-1){let e=this._children[t];e.parent=null;for(let s of this.tags)e.removeTag(s);this._children.splice(t,1)}return this}getChildren(){return this._children}set parent(i){this._parentSprite=i}get parent(){return this._parentSprite}getMainSprite(){return this._parentSprite?this._parentSprite.getMainSprite():this}switchCollider(i){if(this.colliders.has(i)||this.game.throwError(E.COLLIDER_NAME_NOT_FOUND,{colliderName:i}),this.currentColliderName===i)return this;let t=this.collider;t&&this.stage.collisionSystem.remove(t),this.currentColliderName=i;let e=this.collider;return this.stage.collisionSystem.insert(e),this._width=e.width,this._height=e.height,this}get launched(){return!this.onReadyPending}setCollider(i,t,e=0,s=0){if(t.parentSprite=this,t.offset_x=e,t.offset_y=s,this.currentColliderName===i&&this.colliders.has(i)){let r=this.colliders.get(i);this.stage.collisionSystem.remove(r),this.currentColliderName=null}return this.colliders.set(i,t),this.updateColliderPosition(t),this.isReady()&&!this.collider&&this.switchCollider(i),this}setRectCollider(i,t,e,s=0,r=0){let n=0;this._rotateStyle!="leftRight"&&(n=this.globalAngleRadians);let h=new z(this.x,this.y,[[t/2*-1,e/2*-1],[t/2,e/2*-1],[t/2,e/2],[t/2*-1,e/2]],n,this.size/100,this.size/100);return h.width=t,h.height=e,this.setCollider(i,h,s,r),this}setPolygonCollider(i,t,e=0,s=0){let r=0;this._rotateStyle!="leftRight"&&(r=this.globalAngleRadians);let n=this.calculateCentroid(t),h=t.map(c=>[c[0]-n.x,c[1]-n.y]),a=new z(this.x,this.y,h,r,this.size/100,this.size/100),{width:u,height:l}=this.calculatePolygonSize(h);return a.width=u,a.height=l,this.setCollider(i,a,e,s),this}setCircleCollider(i,t,e=0,s=0){let r=new lt(this.x,this.y,t,this.size/100);return r.width=t*2,r.height=t*2,this.setCollider(i,r,e,s),this}setCostumeCollider(i,t=0,e=0,s=0){this.costumes[t]===void 0&&this.game.throwError(E.COSTUME_INDEX_NOT_FOUND,{costumeIndex:t});let r=this.costumes[t];return this.setRectCollider(i,r.width,r.height,e,s),this}removeCollider(i){if(i)this.removeColliderByName(i);else{let t=this.collider;t&&this.stage.collisionSystem.remove(t),this.colliders.clear(),this.currentColliderName=null,this.defaultColliderNone=!0}return this}removeColliderByName(i){let t=this.getCollider(i);if(this.colliders.delete(i),this.colliders.size===0&&(this.defaultColliderNone=!0),i===this.currentColliderName&&(this.stage.collisionSystem.remove(t),this.colliders.size)){let e=this.colliders.keys().next().value;this.switchCollider(e)}return this}getCollider(i){return this.colliders.has(i)||this.game.throwError(E.COLLIDER_NAME_NOT_FOUND,{colliderName:i}),this.colliders.get(i)}hasCollider(i){return this.colliders.has(i)}get collider(){return this.currentColliderName&&this.colliders.has(this.currentColliderName)?this.colliders.get(this.currentColliderName):null}get collidedSprite(){return this._collidedSprite}set defaultColliderNone(i){this._defaultColliderNone=i}get defaultColliderNone(){return this._defaultColliderNone}getColliders(){return this.colliders.entries()}cloneCollider(i){let t=i.getColliders();for(let[e,s]of t)s instanceof lt&&this.setCircleCollider(e,s.radius,s.offset_x,s.offset_y),s instanceof z&&this.setPolygonCollider(e,s.points,s.offset_x,s.offset_y)}calculateCentroid(i){let t=0,e=0;for(let n of i)t+=n[0],e+=n[1];let s=t/i.length,r=e/i.length;return{x:s,y:r}}calculatePolygonSize(i){let t=i[0][0],e=i[0][1],s=i[0][0],r=i[0][1];for(let a of i)a[0]<t&&(t=a[0]),a[0]>s&&(s=a[0]),a[1]<e&&(e=a[1]),a[1]>r&&(r=a[1]);let n=s-t,h=r-e;return{width:n,height:h}}updateColliderPosition(i){i.x=this.imageCenterX+i.center_offset_x*this.size/100,i.y=this.imageCenterY+i.center_offset_y*this.size/100}updateColliderAngle(){let i=this.collider;i instanceof z&&(this._rotateStyle=="leftRight"?i.angle=0:i.angle=this.globalAngleRadians),i&&this.updateColliderPosition(i)}updateColliderSize(i){i instanceof z?(i.scale_x=this.size/100,i.scale_y=this.size/100):i instanceof lt&&(i.scale=this.size/100)}addTag(i){this.hasTag(i)||this._tags.push(i);for(let t of this._children)t.addTag(i);return this}removeTag(i){let t=this._tags.indexOf(i);t>-1&&this._tags.splice(t,1);for(let e of this._children)e.addTag(i);return this}hasTag(i){return this._tags.includes(i)}get tags(){return this._tags}addCostume(i,t){var a;let e=new ot,s=this.costumes.length,r=((a=t==null?void 0:t.name)!=null?a:"Costume")+"-"+s;this.costumes.push(e),this.costumeNames.push(r),this.pendingCostumes++;let n=new Image;n.src=i,t!=null&&t.alphaColor&&(n.crossOrigin="anonymous");let h=()=>{var l,c,d,g,_,y,p,C,x,S,R,b,T,M;if(this.deleted)return;let u=this.transformImage(n,(l=t==null?void 0:t.rotate)!=null?l:0,(c=t==null?void 0:t.flipX)!=null?c:!1,(d=t==null?void 0:t.flipY)!=null?d:!1,(g=t==null?void 0:t.x)!=null?g:0,(_=t==null?void 0:t.y)!=null?_:0,(y=t==null?void 0:t.width)!=null?y:n.naturalWidth,(p=t==null?void 0:t.height)!=null?p:n.naturalHeight,(C=t==null?void 0:t.alphaColor)!=null?C:null,(x=t==null?void 0:t.alphaTolerance)!=null?x:0,(S=t==null?void 0:t.crop)!=null?S:0,(R=t==null?void 0:t.cropTop)!=null?R:null,(b=t==null?void 0:t.cropRight)!=null?b:null,(T=t==null?void 0:t.cropBottom)!=null?T:null,(M=t==null?void 0:t.cropLeft)!=null?M:null);e.image=u,e.ready=!0,this.pendingCostumes--,this.tryDoOnReady(),n.removeEventListener("load",h)};return n.addEventListener("load",h),n.addEventListener("error",()=>{this.game.throwError(E.COSTUME_NOT_LOADED,{costumePath:i})}),this}addCostumeGrid(i,t){var n;let e=new Image;e.src=i;let s=(n=t==null?void 0:t.name)!=null?n:"Costume";this.pendingCostumeGrids++;let r=()=>{var C,x,S,R,b,T,M,k,Q,N,L,B,Y,U;e.naturalWidth,e.naturalHeight;let h=t.cols,a=t.rows,u=t.limit,l=t.offset,c=e.naturalWidth/h,d=e.naturalHeight/a,g=!1,_=0,y=0,p=0;for(let I=0;I<a;I++){for(let P=0;P<h;P++){if(g=!1,l!==null&&l>0&&(l--,g=!0),!g){if(u!==null){if(u==0)break;u>0&&u--}let O=new ot;this.costumes.push(O),this.costumeNames.push(s+"-"+_);let V=this.transformImage(e,(C=t==null?void 0:t.rotate)!=null?C:0,(x=t==null?void 0:t.flipX)!=null?x:!1,(S=t==null?void 0:t.flipY)!=null?S:!1,y+((R=t==null?void 0:t.x)!=null?R:0),p+((b=t==null?void 0:t.y)!=null?b:0),(T=t==null?void 0:t.width)!=null?T:c,(M=t==null?void 0:t.height)!=null?M:d,(k=t==null?void 0:t.alphaColor)!=null?k:null,(Q=t==null?void 0:t.alphaTolerance)!=null?Q:0,(N=t==null?void 0:t.crop)!=null?N:0,(L=t==null?void 0:t.cropTop)!=null?L:null,(B=t==null?void 0:t.cropRight)!=null?B:null,(Y=t==null?void 0:t.cropBottom)!=null?Y:null,(U=t==null?void 0:t.cropLeft)!=null?U:null);O.image=V,O.ready=!0,_++}y+=c}y=0,p+=d}this.pendingCostumeGrids--,this.tryDoOnReady(),e.removeEventListener("load",r)};return e.addEventListener("load",r),this}drawCostume(i,t){var a,u,l,c,d,g,_,y,p,C,x,S,R,b,T,M,k;let e=document.createElement("canvas"),s=e.getContext("2d");e.width=(a=t==null?void 0:t.width)!=null?a:100,e.height=(u=t==null?void 0:t.height)!=null?u:100,this.pendingCostumes++,i(s,this);let r=this.costumes.length,n=((l=t==null?void 0:t.name)!=null?l:"Costume")+"-"+r;Object.values(t||{}).some(Q=>!!Q)&&(e=this.transformImage(e,(c=t==null?void 0:t.rotate)!=null?c:0,(d=t==null?void 0:t.flipX)!=null?d:!1,(g=t==null?void 0:t.flipY)!=null?g:!1,(_=t==null?void 0:t.x)!=null?_:0,(y=t==null?void 0:t.y)!=null?y:0,(p=t==null?void 0:t.width)!=null?p:e.width,(C=t==null?void 0:t.height)!=null?C:e.height,(x=t==null?void 0:t.alphaColor)!=null?x:null,(S=t==null?void 0:t.alphaTolerance)!=null?S:0,(R=t==null?void 0:t.crop)!=null?R:0,(b=t==null?void 0:t.cropTop)!=null?b:null,(T=t==null?void 0:t.cropRight)!=null?T:null,(M=t==null?void 0:t.cropBottom)!=null?M:null,(k=t==null?void 0:t.cropLeft)!=null?k:null));let h=new ot;return h.image=e,h.ready=!0,this.costumes.push(h),this.costumeNames.push(n+"-"+r),this.pendingCostumes--,this}removeCostume(i){return this.costumes[i]===void 0&&this.game.throwError(E.COSTUME_INDEX_NOT_FOUND,{costumeIndex:i}),this.costumes.splice(i,1),this.costumeNames.splice(i,1),this.costumeIndex===i&&(this.costumeIndex=null,this.costumes.length>0?this.nextCostume():this.costume=null),this}switchCostume(i){if(this.deleted)return;this.isReady()||this.game.throwError(E.COSTUME_SWITCH_NOT_READY);let t=this.costumes[i];return t instanceof ot&&t.ready&&(this.costumeIndex=i,this.costume=t),this}switchCostumeByName(i){this.isReady()||this.game.throwError(E.COSTUME_SWITCH_NOT_READY);let t=this.costumeNames.indexOf(i);return t>-1?this.switchCostume(t):this.game.throwError(E.COSTUME_NAME_NOT_FOUND,{costumeName:i}),this}nextCostume(i=0,t){if(this.deleted)return;this.isReady()||this.game.throwError(E.COSTUME_SWITCH_NOT_READY);let e=this.costumes.length-1;i=Math.min(e,Math.max(0,i)),t=Math.min(e,Math.max(0,t!=null?t:e));let s=this.costumeIndex+1;return(s>t||s<i)&&(s=i),s!==this.costumeIndex&&this.switchCostume(s),s}prevCostume(i=0,t){if(this.deleted)return;this.isReady()||this.game.throwError(E.COSTUME_SWITCH_NOT_READY);let e=this.costumes.length-1;i=Math.min(e,Math.max(0,i)),t=Math.min(e,Math.max(0,t!=null?t:e));let s=this.costumeIndex-1;return(s<i||s>t)&&(s=t),s!==this.costumeIndex&&this.switchCostume(s),s}getCostume(){return this.costume}getCostumeName(){return this.costumeIndex===null?"No costume":this.costumeNames[this.costumeIndex]}getCostumeIndex(){return this.costumeIndex}transformImage(i,t,e=!1,s=!1,r=0,n=0,h=null,a=null,u=null,l=0,c=0,d=null,g=null,_=null,y=null){d=d!=null?d:c,g=g!=null?g:c,_=_!=null?_:c,y=y!=null?y:c,r+=g,h-=g,h-=y,n+=d,a-=d,a-=_;let p=document.createElement("canvas"),C=p.getContext("2d"),x=t*Math.PI/180,S=h!=null?h:i instanceof HTMLImageElement?i.naturalWidth:i.width,R=a!=null?a:i instanceof HTMLImageElement?i.naturalHeight:i.height;if(t){let M=Math.abs(Math.cos(x)),k=Math.abs(Math.sin(x));S=S*M+R*k,R=S*k+R*M}p.width=Math.ceil(S),p.height=Math.ceil(R),C.translate(p.width/2,p.height/2),t&&C.rotate(x),(e||s)&&C.scale(e?-1:1,s?-1:1);let b=-h/2,T=-a/2;return C.drawImage(i,r,n,h,a,b,T,h,a),u&&(p=this.setAlpha(p,u,l!=null?l:0)),p}setAlpha(i,t,e=0){let s=document.createElement("canvas"),r=s.getContext("2d");if(!r)throw new Error("Canvas context is not available");s.width=i.width,s.height=i.height;let n=i.getContext("2d").getImageData(0,0,i.width,i.height),h=n.data,a;if(typeof t=="string"){if(a=this.hexToRgb(t),!a)throw new Error(`Invalid HEX color: ${t}`)}else a=t;for(let u=0;u<h.length;u+=4){let l=h[u],c=h[u+1],d=h[u+2];Math.abs(l-a.r)<=e&&Math.abs(c-a.g)<=e&&Math.abs(d-a.b)<=e&&(h[u+3]=0)}return r.putImageData(n,0,0),s}hexToRgb(i){if(i=i.replace(/^#/,""),i.length===3&&(i=i.split("").map(e=>e+e).join("")),i.length!==6)return null;let t=parseInt(i,16);return{r:t>>16&255,g:t>>8&255,b:t&255}}cloneCostume(i,t){this.costumes.push(i),this.costumeNames.push(t)}addSound(i,t){this.soundNames.includes(t)&&this.game.throwError(E.SOUND_NAME_ALREADY_EXISTS,{soundName:t});let e=new Audio;e.src=i,this.sounds.push(e),this.soundNames.push(t),this.pendingSounds++,e.load();let s=()=>{this.pendingSounds--,this.tryDoOnReady(),e.removeEventListener("loadedmetadata",s)};return e.addEventListener("loadedmetadata",s),this}removeSound(i){let t=this.soundNames.indexOf(i);return t<0&&this.game.throwError(E.SOUND_NAME_NOT_FOUND,{soundName:i}),this.sounds.splice(t,1),this}playSound(i,t={}){let e=this.getSound(i);this.doPlaySound(e,t)}startSound(i,t={}){let e=this.cloneSound(i);return this.doPlaySound(e,t),e}pauseSound(i){this.getSound(i).pause()}getSound(i){this.isReady()||this.game.throwError(E.SOUND_USE_NOT_READY);let t=this.soundNames.indexOf(i);t<0&&this.game.throwError(E.SOUND_NAME_NOT_FOUND,{soundName:i});let e=this.sounds[t];return e instanceof Audio||this.game.throwError(E.SOUND_INDEX_NOT_FOUND,{soundIndex:t}),e}cloneSound(i){let t=this.getSound(i);return new Audio(t.src)}doPlaySound(i,t={}){t.volume!==void 0&&(i.volume=t.volume),t.currentTime!==void 0&&(i.currentTime=t.currentTime),t.loop!==void 0&&(i.loop=t.loop);let e=i.play();e!==void 0&&e.catch(s=>{s.name==="NotAllowedError"?this.game.throwError(E.SOUND_NOT_ALLOWED_ERROR,{},!1):console.error("Audio playback error:",s)})}stamp(i,t=!0){this.isReady()||this.game.throwError(E.STAMP_NOT_READY),i=i!=null?i:this.costumeIndex,this.costumes[i]||this.game.throwError(E.STAMP_COSTUME_NOT_FOUND,{costumeIndex:i});let e=this.costumes[i];e.image instanceof HTMLCanvasElement||this.game.throwErrorRaw("The image inside the costume was not found.");let s=0;t&&this._rotateStyle==="normal"&&(s=this.direction),this.stage.stampImage(e.image,this.x,this.y,s)}pen(i){this._drawings.push(i)}get drawings(){return this._drawings}set opacity(i){i===null?this._opacity=null:this._opacity=Math.min(1,Math.max(0,i))}get opacity(){return this._opacity}set filter(i){this._filter=i}get filter(){return this._filter}set rotateStyle(i){this._rotateStyle=i;for(let t of this._children)t.rotateStyle=i}get rotateStyle(){return this._rotateStyle}set layer(i){let t=this._parentSprite?this._parentSprite.globalLayer+i:i;this.stage.changeSpriteLayer(this,this._layer,t),this._layer=i;for(let e of this._children)e.globalLayer=e.layer+this._layer}get layer(){return this._layer}set globalLayer(i){this.layer=this._parentSprite?i-this._parentSprite.globalLayer:i}get globalLayer(){return this._parentSprite?this._parentSprite.globalLayer+this._layer:this._layer}set hidden(i){this._hidden=i;for(let t of this._children)t.hidden=i}get hidden(){return this._hidden}say(i,t){if(this.phrase=this.name+": "+i,this.phraseLiveTime=null,t){let e=new Date().getTime();this.phraseLiveTime=e+t}}getPhrase(){if(this.phrase){if(this.phraseLiveTime===null)return this.phrase;let i=new Date().getTime();if(this.phraseLiveTime>i)return this.phrase;this.phrase=null,this.phraseLiveTime=null}return null}move(i){let t=this.globalAngleRadians;this.x+=i*Math.sin(t),this.y-=i*Math.cos(t)}pointForward(i){let t=i.globalX?i.globalX:i.x,e=i.globalY?i.globalY:i.y;this.globalDirection=Math.atan2(this.globalY-e,this.globalX-t)/Math.PI*180-90}getDistanceTo(i){let t=i.globalX?i.globalX:i.x,e=i.globalY?i.globalY:i.y;return Math.sqrt(Math.abs(this.globalX-t)+Math.abs(this.globalY-e))}bounceOnEdge(){(this.touchTopEdge()||this.touchBottomEdge())&&(this.direction=180-this.direction),(this.touchLeftEdge()||this.touchRightEdge())&&(this.direction*=-1)}set x(i){this._x=i,this._children.length&&this.updateCenterParams();let t=this.collider;t&&this.updateColliderPosition(t);for(let e of this._children)e.collider&&e.updateColliderPosition(e.collider)}get x(){return this._x}set y(i){this._y=i,this._children.length&&this.updateCenterParams();let t=this.collider;t&&this.updateColliderPosition(t);for(let e of this._children)e.collider&&e.updateColliderPosition(e.collider)}get y(){return this._y}get globalX(){return this._parentSprite?this._rotateStyle==="leftRight"||this._rotateStyle==="none"?this._parentSprite.imageCenterX+this._x*this.size/100:this._parentSprite.imageCenterX+this.distanceToParent*Math.cos(this.angleToParent-this._parentSprite.globalAngleRadians)*this.size/100:this._x}get globalY(){return this._parentSprite?this._rotateStyle==="leftRight"||this._rotateStyle==="none"?this._parentSprite.imageCenterY+this._y:this._parentSprite.imageCenterY-this.distanceToParent*Math.sin(this.angleToParent-this._parentSprite.globalAngleRadians)*this.size/100:this._y}get imageCenterX(){if(this._rotateStyle==="leftRight"||this._rotateStyle==="none"){let i=this._direction>180&&this._rotateStyle==="leftRight"?-1:1;return this.globalX-this._pivotOffsetX*i*this.size/100}return this.globalX+Math.cos(this._centerAngle-this.globalAngleRadians)*this._centerDistance*this.size/100}get imageCenterY(){return this._rotateStyle==="leftRight"||this._rotateStyle==="none"?this.globalY-this._pivotOffsetY*this.size/100:this.globalY-Math.sin(this._centerAngle-this.globalAngleRadians)*this._centerDistance*this.size/100}get realX(){return this.x-this.width/2}get realY(){return this.y-this.height/2}get rightX(){let i=this.collider,t=i?i.center_offset_x*this.size/100:0;return this.imageCenterX+this.width/2+t}set rightX(i){let t=this.collider,e=t?t.center_offset_x*this.size/100:0;this.x=i-this.width/2-e}get leftX(){let i=this.collider,t=i?i.center_offset_x*this.size/100:0;return this.imageCenterX-this.width/2+t}set leftX(i){let t=this.collider,e=t?t.center_offset_x*this.size/100:0;this.x=i+this.width/2+e}get topY(){let i=this.collider,t=i?i.center_offset_y*this.size/100:0;return this.imageCenterY-this.height/2+t}set topY(i){let t=this.collider,e=t?t.center_offset_y*this.size/100:0;this.y=i+this.height/2+e}get bottomY(){let i=this.collider,t=i?i.center_offset_y*this.size/100:0;return this.imageCenterY+this.height/2+t}set bottomY(i){let t=this.collider,e=t?t.center_offset_y*this.size/100:0;this.y=i-this.height/2-e}get width(){if(this.collider instanceof z&&this._rotateStyle==="normal"){let i=this.globalAngleRadians;return Math.abs(this.sourceWidth*Math.cos(i))+Math.abs(this.sourceHeight*Math.sin(i))}return this.sourceWidth}get height(){if(this.collider instanceof z&&this._rotateStyle==="normal"){let i=this.globalAngleRadians;return Math.abs(this.sourceWidth*Math.sin(i))+Math.abs(this.sourceHeight*Math.cos(i))}return this.sourceHeight}get sourceWidth(){return this._width*this.size/100}get sourceHeight(){return this._height*this.size/100}set size(i){this._size=i;let t=this.collider;t&&this.updateColliderSize(t);for(let e of this._children)e.size=i}get size(){return this._size}set direction(i){if(i*0===0){i=i%360,i<0&&(i+=360),this._direction=i>360?i-360:i,this.updateColliderAngle();for(let t of this._children)t.updateColliderAngle()}}get direction(){return this._direction}set globalDirection(i){this.direction=this._parentSprite?i-this._parentSprite.globalDirection:i}get globalDirection(){return this._parentSprite?this._parentSprite.globalDirection+this.direction:this.direction}get globalAngleRadians(){return this.globalDirection*Math.PI/180}get angleToParent(){return-Math.atan2(this.y,this.x)}get distanceToParent(){return Math.hypot(this.x,this.y)}setPivotOffset(i=0,t=0){return this.pivotOffsetX=i,this.pivotOffsetY=t,this}set pivotOffsetX(i){let t=this.x;this._pivotOffsetX=i,this.updateCenterParams(),this.x=t}get pivotOffsetX(){return this._pivotOffsetX}set pivotOffsetY(i){let t=this.y;this._pivotOffsetY=i,this.updateCenterParams(),this.y=t}get pivotOffsetY(){return this._pivotOffsetY}updateCenterParams(){this._centerDistance=Math.hypot(this._pivotOffsetX,this._pivotOffsetY),this._centerAngle=-Math.atan2(-this._pivotOffsetY,-this._pivotOffsetX)}touchSprite(i,t=!0){if(this._collidedSprite=null,i.hidden||this.hidden||i.stopped||this.stopped||i.deleted||this.deleted)return!1;let e=this.collider,s=i.collider;if(e&&s&&e.collides(s,this.collisionResult))return!0;if(e){for(let r of i.getChildren())if(this.touchSprite(r,!1))return!0}if(!t)return!1;for(let r of this._children){if(s&&r.touchSprite(i))return this._collidedSprite=r,!0;for(let n of i.getChildren())if(r.touchSprite(n))return this._collidedSprite=r,!0}return!1}touchSprites(i,t=!0){if(this.hidden||this.stopped||this.deleted)return!1;for(let e of i)if(this.touchSprite(e,t))return!0;return!1}touchMouse(i=!0){return this.touchPoint(this.game.getMousePoint(),i)}touchPoint(i,t=!0){if(this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;let e=this.collider;if(e&&e.collides(i,this.collisionResult))return!0;if(t){for(let s of this._children)if(s.touchPoint(s.game.getMousePoint()))return this._collidedSprite=s.otherSprite,!0}return!1}touchEdge(i=!0){let t=this.getPureCollisionResult();if(this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;if(this.collider){let e=this.game.width,s=this.game.height;if(this.topY<0)return t.collision=!0,t.overlap=-this.topY,t.overlap_y=-1,!0;if(this.bottomY>s)return t.collision=!0,t.overlap=this.bottomY-s,t.overlap_y=1,!0;if(this.leftX<0)return t.collision=!0,t.overlap=-this.leftX,t.overlap_x=-1,!0;if(this.rightX>e)return t.collision=!0,t.overlap=this.rightX-e,t.overlap_x=1,!0}if(i){for(let e of this._children)if(e.touchEdge())return this._collidedSprite=e,!0}return!1}touchTopEdge(i=!0){if(this.clearCollisionResult(),this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;if(this.collider&&this.topY<0)return this.collisionResult.collision=!0,this.collisionResult.overlap=-this.topY,this.collisionResult.overlap_y=-1,!0;if(i){for(let t of this._children)if(t.touchTopEdge())return this._collidedSprite=t,!0}return!1}touchBottomEdge(i=!0){if(this.clearCollisionResult(),this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;if(this.collider&&this.bottomY>this.game.height)return this.collisionResult.collision=!0,this.collisionResult.overlap=this.bottomY-this.game.height,this.collisionResult.overlap_y=1,!0;if(i){for(let t of this._children)if(t.touchBottomEdge())return this._collidedSprite=t,!0}return!1}touchLeftEdge(i=!0){if(this.clearCollisionResult(),this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;if(this.collider&&this.leftX<0)return this.collisionResult.collision=!0,this.collisionResult.overlap=-this.leftX,this.collisionResult.overlap_x=-1,!0;if(i){for(let t of this._children)if(t.touchLeftEdge())return this._collidedSprite=t,!0}return!1}touchRightEdge(i=!0){if(this.clearCollisionResult(),this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;if(this.collider&&this.rightX>this.game.width)return this.collisionResult.collision=!0,this.collisionResult.overlap=this.rightX-this.game.width,this.collisionResult.overlap_x=1,!0;if(i){for(let t of this._children)if(t.touchRightEdge())return this._collidedSprite=t,!0}return!1}touchTag(i,t=!0){if(this.hidden||this.stopped||this.deleted)return!1;this.clearCollisionResult(),this._collidedSprite=null;let e=this.collider;if(e){let s=e.potentials();if(!s.length)return!1;for(let r of s){let n=r.parentSprite;if(n&&n.hasTag(i)&&!n.hidden&&!n.stopped&&!n.deleted&&e.collides(r,this.collisionResult))return!0}}if(t){for(let s of this._children)if(s.touchTag(i))return this._collidedSprite=s,!0}return!1}touchTagAll(i,t=!0){if(this.hidden||this.stopped||this.deleted)return!1;this.clearCollisionResult(),this._collidedSprite=null;let e=[],s=this.collider;if(s){let r=s.potentials();if(!r.length)return!1;for(let n of r){let h=n.parentSprite;h&&h.hasTag(i)&&!h.hidden&&!h.stopped&&!h.deleted&&h.collider&&s.collides(n,this.collisionResult)&&e.push(h)}}if(t)for(let r of this._children){let n=r.touchTagAll(i);if(n&&!n.length)for(let h of n)e.push(h)}return e.length?e:!1}touchAnySprite(i=!0){if(this.clearCollisionResult(),this._collidedSprite=null,this.hidden||this.stopped||this.deleted)return!1;let t=this.collider;if(t){let e=t.potentials();if(!e.length)return!1;for(let s of e){let r=s.parentSprite;if(!r.hidden&&!r.stopped&&!r.deleted&&t.collides(s,this.collisionResult))return!0}}if(i){for(let e of this._children)if(e.touchAnySprite())return this._collidedSprite=e,!0}return!1}get overlap(){return this._collidedSprite?this._collidedSprite.overlap:this.collisionResult.collision?this.collisionResult.overlap:0}get overlapX(){return this._collidedSprite?this._collidedSprite.overlapX:this.collisionResult.collision?this.collisionResult.overlap_x*this.collisionResult.overlap:0}get overlapY(){return this._collidedSprite?this._collidedSprite.overlapY:this.collisionResult.collision?this.collisionResult.overlap_y*this.collisionResult.overlap:0}get otherSprite(){return this.collisionResult.collision?this.collisionResult.b.parentSprite:null}get otherMainSprite(){return this.collisionResult.collision?this.collisionResult.b.parentSprite.getMainSprite():null}clearCollisionResult(){this.collisionResult.collision=!1,this.collisionResult.a=null,this.collisionResult.b=null,this.collisionResult.a_in_b=!1,this.collisionResult.b_in_a=!1,this.collisionResult.overlap=0,this.collisionResult.overlap_x=0,this.collisionResult.overlap_y=0}getPureCollisionResult(){return this.clearCollisionResult(),this.collisionResult}timeout(i,t){this.repeat(i,1,null,t,void 0)}repeat(i,t,e,s,r){let n=new dt(e,t,0);return s&&(s=Date.now()+s),this.tempScheduledCallbacks.push(new ct(i,n,s,r)),n}forever(i,t,e,s){let r=new dt(t);return e&&(e=Date.now()+e),this.tempScheduledCallbacks.push(new ct(i,r,e,s)),r}update(){this.deleted||(this.tempScheduledCallbacks.length&&(this.scheduledCallbacks=this.scheduledCallbacks.concat(this.tempScheduledCallbacks),this.tempScheduledCallbacks=[]),this.scheduledCallbacks=this.scheduledCallbacks.filter(this.scheduledCallbackExecutor.execute(Date.now(),this.diffTime)),this.diffTime=0)}run(){this._stopped=!1,this.diffTime=Date.now()-this.stoppedTime}stop(){this._stopped=!0,this.stoppedTime=Date.now()}ready(){this.tryDoOnReady()}get original(){return this._original}get activeStage(){return this.stage}setOriginal(i){this._original=i}createClone(i){this.isReady()||this.game.throwError(E.CLONED_NOT_READY),i||(i=this.stage);let t=this.constructor,e=new t(i,this.layer,[],this);e.name=this.name,e._rotateStyle=this._rotateStyle,e.x=this.x,e.y=this.y,e.pivotOffsetX=this.pivotOffsetX,e.pivotOffsetY=this.pivotOffsetY,e.direction=this.direction,e.size=this.size,e.hidden=this.hidden,e._deleted=this.deleted,e._stopped=this.stopped,e._tags.push(...this.tags),e.defaultColliderNone=this.defaultColliderNone,e.stoppedTime=this.stoppedTime;for(let s=0;s<this.costumes.length;s++)e.cloneCostume(this.costumes[s],this.costumeNames[s]);e.switchCostume(this.costumeIndex);for(let[s,r]of this.sounds.entries())e.sounds.push(r),e.soundNames.push(this.soundNames[s]);e.currentColliderName=null,e.cloneCollider(this),this.currentColliderName&&e.switchCollider(this.currentColliderName);for(let s of this._children){let r=s.createClone();e.addChild(r),r.x=s.x,r.y=s.y,r.direction=s.direction}return e.ready(),e}delete(){if(this.deleted)return;this.stage.removeSprite(this,this.layer),this.eventEmitter.clearAll(),this.removeCollider(),this.scheduledCallbackExecutor=null;for(let t of this._children)t.delete();let i=Object.keys(this);for(let t=0;t<i.length;t++)delete this[i[t]];this.costumes=[],this.costumeNames=[],this.sounds=[],this.soundNames=[],this.onReadyCallbacks=[],this.tempScheduledCallbacks=[],this.scheduledCallbacks=[],this._children=[],this._deleted=!0}deleteClones(){this.stage.getSprites().filter(i=>i.original===this).forEach(i=>i.delete())}setStage(i){if(i!=this.stage){this.game.isReady()||this.game.throwError(E.STAGE_SET_BEFORE_GAME_READY),this.stage.removeSprite(this,this.globalLayer),i.addSprite(this),this.collider&&(this.stage.collisionSystem.remove(this.collider),i.collisionSystem.insert(this.collider)),this.stage=i,this.stop();for(let t of this._children)t.setStage(i)}}tryDoOnReady(){if(this.onReadyPending&&this.isReady()){if(this.onReadyPending=!1,this.costumes.length&&this.costume===null&&this.switchCostume(0),!this.defaultColliderNone&&this.colliders.size===0&&this.costumes.length){let i="main";this.setCostumeCollider(i,0),this.switchCollider(i),this.updateColliderPosition(this.collider),this.updateColliderSize(this.collider)}if(!this.collider&&this.colliders.size){let i=this.colliders.keys().next().value;this.switchCollider(i),this.updateColliderPosition(this.collider),this.updateColliderSize(this.collider)}if(this.onReadyCallbacks.length){for(let i of this.onReadyCallbacks)i();this.onReadyCallbacks=[]}this.stage.eventEmitter.emit(tt.SPRITE_READY_EVENT,{sprite:this,stageId:this.stage.id})}}},Xt=class{constructor(i){this.context=i}execute(i,t){return e=>{let s=e.state;if(this.context instanceof v){if(this.context.deleted)return!1;if(this.context.stopped)return!0}if(e.timeout&&t&&(e.timeout+=t),!e.timeout||e.timeout<=i){let r=e.callback.bind(this.context)(this.context,s);if(s.maxIterations&&s.currentIteration++,r===!1||e.timeout&&!s.interval&&!s.maxIterations||s.maxIterations&&s.currentIteration>=s.maxIterations)return e.finishCallback&&e.finishCallback(this.context,s),!1;s.interval&&(e.timeout=i+s.interval)}return!0}}},ne=class{constructor(){this.x=0,this.y=0,this.zoom=1,this.direction=0}reset(){this.x=0,this.y=0,this.zoom=1,this.direction=0}},ae=class{constructor(i){this._direction=0,this._zoom=1,this.stage=i,this._x=this.stage.width/2,this._y=this.stage.height/2,this.updateRenderRadius(),this.changes=new ne}set direction(i){if(this.changes.direction==0){let t=i%360;t=t<0?t+360:t,this.changes.direction=t-this._direction,this._direction=t}}get direction(){return this._direction}get angleDirection(){return this._direction*Math.PI/180}get width(){return this.stage.width/this._zoom}get height(){return this.stage.height/this._zoom}set x(i){this.changes.x=i-this._x}get x(){return this._x+this.changes.x}set y(i){this.changes.y=i-this._y}get y(){return this._y+this.changes.y}get startCornerX(){return this._x-this.stage.width/2}get startCornerY(){return this._y-this.stage.height/2}get renderRadius(){return this._renderRadius}set zoom(i){if(this.changes.zoom==1){let t=i<.1?.1:i;this.changes.zoom=t/this._zoom,this._zoom=t,this.updateRenderRadius()}}get zoom(){return this._zoom}stop(){this.stage.context.translate(this._x-this.stage.width/2,this._y-this.stage.height/2),this.stage.context.translate(this.stage.width/2,this.stage.height/2),this.stage.context.scale(1/this._zoom,1/this._zoom),this.stage.context.translate(-this.stage.width/2,-this.stage.height/2),this._renderRadius=Math.hypot(this.stage.width,this.stage.height)/1.5}run(){this.stage.context.translate(-this._x+this.stage.width/2,-this._y+this.stage.height/2),this.stage.context.translate(this._x,this._y),this.stage.context.scale(this._zoom,this._zoom),this.stage.context.translate(-this._x,-this._y),this.updateRenderRadius(),this.changes.reset()}update(){this._x+=this.changes.x,this._y+=this.changes.y}updateRenderRadius(){this._renderRadius=Math.hypot(this.width,this.height)/1.5}},Ht=class{constructor(i=null){if(this.background=null,this.backgroundIndex=null,this.backgrounds=[],this.sprites=new Map,this.drawings=new Map,this.sounds=[],this.soundNames=[],this.addedSprites=0,this.loadedSprites=0,this.pendingBackgrounds=0,this.pendingSounds=0,this.pendingRun=!1,this.onReadyPending=!0,this.onReadyCallbacks=[],this.onStartCallbacks=[],this.scheduledCallbacks=[],this.tempScheduledCallbacks=[],this._stopped=!0,this._running=!1,this.stoppedTime=null,this.diffTime=null,!it.getInstance().has("game"))throw new Error("You need create Game instance before Stage instance.");this.game=it.getInstance().get("game");let t=this;return this.game.displayErrors&&(t=this.game.validatorFactory.createValidator(this,"Stage")),t.id=Symbol(),t.eventEmitter=new Rt,t.collisionSystem=new te,t.canvas=t.game.canvas,t.context=t.game.context,i&&t.addBackground(i),t.addListeners(),t.game.addStage(t),t.scheduledCallbackExecutor=new Xt(t),t.stoppedTime=Date.now(),t.init(),t.camera=new ae(t),t}init(){}onStart(i){this.onStartCallbacks.push(i)}onReady(i){this.onReadyCallbacks.push(i)}get running(){return this._running}get stopped(){return this._stopped}isReady(){return this.addedSprites==this.loadedSprites&&this.pendingBackgrounds===0||this.game.isReady()}get width(){return this.canvas.width}get height(){return this.canvas.height}set backgroundColor(i){this.drawBackground((t,e)=>{t.fillStyle=i,t.fillRect(0,0,e.width,e.height)})}get currentStoppedTime(){return this.stoppedTime}drawBackground(i){let t=document.createElement("canvas"),e=t.getContext("2d");return t.width=this.width,t.height=this.height,this.pendingBackgrounds++,i(e,this),this.backgrounds.push(t),this.pendingBackgrounds--,this}addBackground(i){let t=new Image;t.src=i,this.pendingBackgrounds++;let e=()=>{let s=document.createElement("canvas"),r=s.getContext("2d");s.width=this.width,s.height=this.height,r.drawImage(t,0,0,this.width,this.height),this.backgrounds.push(s),this.pendingBackgrounds--,this.tryDoOnReady(),this.tryDoRun(),t.removeEventListener("load",e)};return t.addEventListener("load",e),t.addEventListener("error",()=>{this.game.throwError(E.BACKGROUND_NOT_LOADED,{backgroundPath:i})}),this}switchBackground(i){this.backgroundIndex=i;let t=this.backgrounds[i];t&&(this.background=t)}nextBackground(){let i=this.backgroundIndex+1;i>this.backgrounds.length-1&&(i=0),i!==this.backgroundIndex&&this.switchBackground(i)}addSound(i,t){this.soundNames.includes(t)&&this.game.throwError(E.SOUND_NAME_ALREADY_EXISTS,{soundName:t});let e=new Audio;e.src=i,this.sounds.push(e),this.soundNames.push(t),this.pendingSounds++,e.load();let s=()=>{this.pendingSounds--,this.tryDoOnReady(),e.removeEventListener("loadedmetadata",s)};return e.addEventListener("loadedmetadata",s),this}removeSound(i){let t=this.soundNames.indexOf(i);return t<0&&this.game.throwError(E.SOUND_NAME_NOT_FOUND,{soundName:i}),this.sounds.splice(t,1),this}playSound(i,t={}){let e=this.getSound(i);this.doPlaySound(e,t)}startSound(i,t={}){let e=this.cloneSound(i);return this.doPlaySound(e,t),e}pauseSound(i){this.getSound(i).pause()}getSound(i){this.isReady()||this.game.throwError(E.SOUND_USE_NOT_READY);let t=this.soundNames.indexOf(i);t<0&&this.game.throwError(E.SOUND_NAME_NOT_FOUND,{soundName:i});let e=this.sounds[t];return e instanceof Audio||this.game.throwError(E.SOUND_INDEX_NOT_FOUND,{soundIndex:t}),e}cloneSound(i){let t=this.getSound(i);return new Audio(t.src)}doPlaySound(i,t={}){t.volume!==void 0&&(i.volume=t.volume),t.currentTime!==void 0&&(i.currentTime=t.currentTime),t.loop!==void 0&&(i.loop=t.loop);let e=i.play();e!==void 0&&e.catch(s=>{s.name==="NotAllowedError"?this.game.throwError(E.SOUND_NOT_ALLOWED_ERROR,{},!1):console.error("Audio playback error:",s)})}addSprite(i){let t;return this.sprites.has(i.globalLayer)?t=this.sprites.get(i.globalLayer):(t=[],this.sprites.set(i.globalLayer,t)),t.push(i),this.addedSprites++,this}removeSprite(i,t){this.sprites.has(t)||this.game.throwErrorRaw('The layer "'+t+'" not defined in the stage.');let e=this.sprites.get(t);return e.splice(e.indexOf(i),1),e.length||this.sprites.delete(t),(i.deleted||i.isReady())&&this.loadedSprites--,this.addedSprites--,this}getSprites(){return Array.from(this.sprites.values()).reduce((i,t)=>i.concat(t),[])}changeSpriteLayer(i,t,e){this.sprites.has(t)||this.game.throwErrorRaw('The layer "'+t+'" not defined in the stage.');let s=this.sprites.get(t);s.splice(s.indexOf(i),1),s.length||this.sprites.delete(t);let r=[];this.sprites.has(e)?r=this.sprites.get(e):this.sprites.set(e,r),r.push(i)}drawSprite(i){let t=i.getCostume(),e=t.image,s=i.imageCenterX-i.sourceWidth/2,r=i.imageCenterY-i.sourceHeight/2,n=i.sourceWidth,h=i.sourceHeight,a=i.globalDirection,u=i.rotateStyle,l=(i.sourceWidth-t.width*i.size/100)/2,c=(i.sourceHeight-t.height*i.size/100)/2,d=u==="normal"&&a!==0||u==="leftRight"&&a>180||i.opacity!==null||i.filter!==null&&i.filter!="";d&&this.context.save(),i.opacity!==null&&(this.context.globalAlpha=i.opacity),i.filter&&(this.context.filter=i.filter),u==="normal"&&a!==0&&(this.context.translate(s+n/2,r+h/2),this.context.rotate(i.globalAngleRadians),this.context.translate(-s-n/2,-r-h/2)),u==="leftRight"&&a>180?(this.context.scale(-1,1),this.context.drawImage(e,0,0,t.width,t.height,-s-n+l,r+c,t.width*i.size/100,t.height*i.size/100)):this.context.drawImage(e,0,0,t.width,t.height,s+l,r+c,t.width*i.size/100,t.height*i.size/100),d&&this.context.restore()}stampImage(i,t,e,s=0){if(this.background instanceof HTMLCanvasElement){let r=document.createElement("canvas"),n=r.getContext("2d");r.width=this.width,r.height=this.height,n.drawImage(this.background,0,0,this.width,this.height);let h=i instanceof HTMLImageElement?i.naturalWidth:i.width,a=i instanceof HTMLImageElement?i.naturalHeight:i.height,u=t-h/2,l=e-a/2;if(s!==0){let c=s*Math.PI/180;n.translate(u+h/2,l+a/2),n.rotate(c),n.translate(-u-h/2,-l-a/2)}n.drawImage(i,u,l,h,a),this.background=r,this.backgrounds[this.backgroundIndex]=this.background}}pen(i,t=0){let e;this.drawings.has(t)?e=this.drawings.get(t):(e=[],this.drawings.set(t,e)),e.push(i)}timeout(i,t){this.repeat(i,1,null,t,void 0)}repeat(i,t,e=null,s=null,r){let n=new dt(e,t,0);return s&&(s=Date.now()+s),this.tempScheduledCallbacks.push(new ct(i,n,s,r)),n}forever(i,t=null,e=null,s){let r=new dt(t);return e&&(e=Date.now()+e),this.tempScheduledCallbacks.push(new ct(i,r,e,s)),r}render(){this.update(),this.collisionSystem.update(),this.context.clearRect(this.camera.startCornerX-this.camera.width/this.camera.zoom/2,this.camera.startCornerY-this.camera.height/this.camera.zoom/2,this.width+this.camera.width/this.camera.zoom,this.height+this.camera.height/this.camera.zoom),this.background&&this.context.drawImage(this.background,0,0,this.width,this.height);let i=Array.from(this.sprites.keys()).concat(Array.from(this.drawings.keys()));i=i.filter((s,r)=>i.indexOf(s)===r),i=i.sort((s,r)=>s-r);for(let s of i){if(this.drawings.has(s)){let r=this.drawings.get(s);for(let n of r)n(this.context,this)}if(this.sprites.has(s)){let r=this.sprites.get(s);for(let n of r){if(n.hidden)continue;let h=Math.hypot(n.imageCenterX-this.camera.x,n.imageCenterY-this.camera.y),a=Math.hypot(n.sourceWidth,n.sourceHeight)/1.5*this.camera.zoom;if(h>=this.camera.renderRadius+a)continue;if(this.game.debugMode!=="none"){let l=()=>{let c=n.imageCenterX-this.context.measureText(n.name).width/2,d=n.imageCenterY+n.height+20;this.context.fillStyle=this.game.debugColor,this.context.font="16px Arial",this.context.fillText(n.name,c,d),d+=20,this.context.font="14px Arial",this.context.fillText("x: "+n.x,c,d),d+=20,this.context.fillText("y: "+n.y,c,d),d+=20,this.context.fillText("direction: "+n.direction,c,d),d+=20,this.context.fillText("costume: "+n.getCostumeName(),c,d),d+=20,this.context.fillText("xOffset: "+n.pivotOffsetX,c,d),d+=20,this.context.fillText("yOffset: "+n.pivotOffsetY,c,d),this.context.beginPath(),this.context.moveTo(n.globalX-2,n.globalY),this.context.lineTo(n.globalX+2,n.globalY),this.context.moveTo(n.globalX,n.globalY-2),this.context.lineTo(n.globalX,n.globalY+2),this.context.stroke()};this.game.debugMode==="hover"&&n.touchMouse()&&l(),this.game.debugMode==="forever"&&l()}let u=n.getPhrase();u&&(this.context.font="20px Arial",this.context.fillStyle="black",this.context.fillText(u,40,this.canvas.height-40)),n.getCostume()&&this.drawSprite(n);for(let l of n.drawings)l(this.context,n)}}}this.game.debugCollider&&(this.context.strokeStyle=this.game.debugColor,this.context.beginPath(),this.collisionSystem.draw(this.context),this.context.stroke()),this.context.translate(-this.camera.changes.x,-this.camera.changes.y);let t=this.width/2+this.camera.startCornerX,e=this.height/2+this.camera.startCornerY;this.context.translate(t,e),this.context.scale(this.camera.changes.zoom,this.camera.changes.zoom),this.context.translate(-t,-e),this.camera.update(),this.camera.changes.reset()}update(){this.tempScheduledCallbacks.length&&(this.scheduledCallbacks=this.scheduledCallbacks.concat(this.tempScheduledCallbacks),this.tempScheduledCallbacks=[]),this.scheduledCallbacks=this.scheduledCallbacks.filter(this.scheduledCallbackExecutor.execute(Date.now(),this.diffTime)),this.sprites.forEach((i,t)=>{for(let e of i){if(e.deleted){this.removeSprite(e,t);return}e.update()}}),this.diffTime=0}run(){if(this._stopped){this._stopped=!1,this.camera.run();for(let i of this.sprites.values())for(let t of i)t.run();this.pendingRun=!0,this.tryDoRun()}}ready(){this.tryDoOnReady(),this.tryDoRun();for(let i of this.sprites.values())for(let t of i)t.ready()}stop(){if(!this._stopped){this._running=!1,this._stopped=!0;for(let i of this.sprites.values())for(let t of i)t.stop();this.camera.stop(),this.stoppedTime=Date.now()}}tryDoOnReady(){if(this.onReadyPending&&this.isReady()){if(this.onReadyPending=!1,this.backgrounds.length&&this.backgroundIndex===null&&this.switchBackground(0),this.onReadyCallbacks.length){for(let i of this.onReadyCallbacks)i();this.onReadyCallbacks=[]}this.game.eventEmitter.emit(tt.STAGE_READY_EVENT,{stage:this})}}doOnStart(){for(let i of this.onStartCallbacks)setTimeout(()=>{i()})}tryDoRun(){this.pendingRun&&!this._running&&this.isReady()&&(this._running=!0,this.pendingRun=!1,this.doOnStart(),this.diffTime=Date.now()-this.stoppedTime,setTimeout(()=>{let i=this.stoppedTime,t=()=>{this._stopped||i!==this.stoppedTime||(this.render(),requestAnimationFrame(t))};t()}))}addListeners(){this.eventEmitter.on(tt.SPRITE_READY_EVENT,tt.SPRITE_READY_EVENT,i=>{this.id==i.detail.stageId&&(this.loadedSprites++,this.tryDoOnReady(),this.tryDoRun())})}};class vt extends v{init(){this.forever(this.control)}static create(t,e,s=300){const r=new vt;return r.addCostume(e),r.layer=t,r.bg=10-t*2,r.size=s,r}control(){const t=this.game.getMousePoint();this.x=this.stage.width/2+(t.x-this.stage.width/2)/this.bg}}const m=class m{constructor(){o(this,"passedTime",0);o(this,"limitTime",400);o(this,"frozenEggs",0);o(this,"eggshell",0);o(this,"manure",0);o(this,"food",500);o(this,"chick",0);o(this,"chicken",0);o(this,"pollution",0);o(this,"comfortChickenQuantity",0);o(this,"teachingMode",!0);o(this,"rooms",[]);o(this,"drones",[]);o(this,"shipsConfig",[[{type:m.SORTING_ROOM_TYPE,x:206,y:152},{type:m.INCUBATOR_ROOM_TYPE,x:292,y:152},{type:m.NURSERY_ROOM_TYPE,x:377,y:152},{type:m.COOP_ROOM_TYPE,x:477,y:200},{type:m.FARM_ROOM_TYPE,x:477,y:357},{type:m.EMPTY_ROOM_TYPE,x:206,y:244},{type:m.EMPTY_ROOM_TYPE,x:292,y:198},{type:m.EMPTY_ROOM_TYPE,x:378,y:198},{type:m.EMPTY_ROOM_TYPE,x:377,y:357},{type:m.EMPTY_ROOM_TYPE,x:206,y:198},{type:m.EMPTY_ROOM_TYPE,x:292,y:244},{type:m.EMPTY_ROOM_TYPE,x:377,y:244},{type:m.EMPTY_ROOM_TYPE,x:476,y:244},{type:m.EMPTY_ROOM_TYPE,x:206,y:288},{type:m.EMPTY_ROOM_TYPE,x:330,y:291},{type:m.EMPTY_ROOM_TYPE,x:422,y:291}]]);o(this,"currentShip",0);o(this,"personAnimations",{HeroNormal:["public/images/persons/hero/normal_1.png","public/images/persons/hero/normal_2.png","public/images/persons/hero/normal_3.png","public/images/persons/hero/normal_4.png"],BossNormal:["public/images/persons/boss/normal_1.png","public/images/persons/boss/normal_2.png","public/images/persons/boss/normal_3.png","public/images/persons/boss/normal_4.png"],RicoNormal:["public/images/persons/rico/normal_1.png","public/images/persons/rico/normal_2.png","public/images/persons/rico/normal_3.png","public/images/persons/rico/normal_4.png"],CCCNormal:["public/images/persons/ccc/normal_1.png","public/images/persons/ccc/normal_2.png","public/images/persons/ccc/normal_3.png","public/images/persons/ccc/normal_4.png"],HeroAngry:["public/images/persons/hero/angry_1.png","public/images/persons/hero/angry_2.png","public/images/persons/hero/angry_3.png","public/images/persons/hero/angry_4.png"],BossAngry:["public/images/persons/boss/angry_1.png","public/images/persons/boss/angry_2.png","public/images/persons/boss/angry_3.png","public/images/persons/boss/angry_4.png"],RicoAngry:["public/images/persons/rico/angry_1.png","public/images/persons/rico/angry_2.png","public/images/persons/rico/angry_3.png","public/images/persons/rico/angry_4.png"],CCCAngry:["public/images/persons/ccc/angry_1.png","public/images/persons/ccc/angry_2.png","public/images/persons/ccc/angry_3.png","public/images/persons/ccc/angry_4.png"]});o(this,"heroAnswers",{Normal:["Вас понял","Хорошо","Приму к сведению","Спасибо за информацию"],Angry:["Вас понял","Хорошо","Приму к сведению","Спасибо за информацию"]});o(this,"roomsConfig",{[m.EMPTY_ROOM_TYPE]:{name:"Незанятый модуль",cost:0,helpText:"Незанятый модуль, готовый к преобразованию в любой производственный отсек.",instructionText:"Изучите доступные варианты и создайте отсек, который максимально соответствует вашим текущим производственным задачам",backgroundImage:"public/images/rooms/backgrounds/empty.png",thumbnailImage:"public/images/rooms/thumbnails/empty.png",shopImage:null},[m.SORTING_ROOM_TYPE]:{name:"Сортировка",cost:0,helpText:"Сортировка - отсек для обработки и распределения яиц между криокамерой и инкубатором.",instructionText:"Распределяйте яйца между криокамерой (для выполнения миссии) и инкубатором (для пополнения поголовья)",backgroundImage:"public/images/rooms/backgrounds/sorting.png",thumbnailImage:"public/images/rooms/thumbnails/sorting.png",shopImage:null},[m.INCUBATOR_ROOM_TYPE]:{name:"Инкубатор",cost:5e3,helpText:"Инкубатор - отсек для искусственного выведения цыплят из яиц в контролируемых условиях.",instructionText:"Следите за вылуплением цыплят и своевременно очищайте аппараты от скорлупы. Не допускайте длительного нахождения цыплят в инкубаторе",backgroundImage:"public/images/rooms/backgrounds/incubator.png",thumbnailImage:"public/images/rooms/thumbnails/incubator.png",shopImage:"public/images/rooms/shop/incubator.png"},[m.NURSERY_ROOM_TYPE]:{name:"Цыплятник",cost:9e3,helpText:"Цыплятник - модуль для выращивания молодняка до взрослых особей.",instructionText:"Отслеживайте рост цыплят и переводите их в загон при достижении зрелости. Регулярно очищайте помещение от помета",backgroundImage:"public/images/rooms/backgrounds/nursery.png",thumbnailImage:"public/images/rooms/thumbnails/nursery.png",shopImage:"public/images/rooms/shop/nursery.png"},[m.COOP_ROOM_TYPE]:{name:"Стадо",cost:5e3,helpText:"Стадо - основное помещение содержания взрослых кур-несушек.",instructionText:"Собирайте яйца по завершении цикла кладки. Поддерживайте чистоту для сохранения продуктивности несушек",backgroundImage:"public/images/rooms/backgrounds/coop.png",thumbnailImage:"public/images/rooms/thumbnails/coop.png",shopImage:"public/images/rooms/shop/coop.png"},[m.FARM_ROOM_TYPE]:{name:"Ферма",cost:15e3,helpText:"Ферма - гидропонный комплекс производства кормовых культур.",instructionText:"Используйте помет и скорлупу для производства комбикорма. Своевременно собирайте урожай кормовых культур",backgroundImage:"public/images/rooms/backgrounds/farm.png",thumbnailImage:"public/images/rooms/thumbnails/farm.png",shopImage:"public/images/rooms/shop/farm.png"}});o(this,"currentMission",-1);o(this,"successfulCompletedMissions",0);o(this,"missions",[{name:"Марс-7",eggQuota:50,distance:100,successChangeRating:5,failChangeRating:-5,task:"Планета: Марс-7 (Агрикультурный сектор). Доставьте 50 яиц первой партии для обеспечения белком научной колонии. Ученые проводят эксперименты по адаптации земной флоры и фауны к марсианским условиям. Ваш груз станет основой для создания устойчивой экосистемы",success:"УСПЕХ! Марс-7: Квота выполнена! Научная колония получила жизненно важные белки",fail:"ПРОВАЛ! Марс-7: Квота не выполнена! Колония осталась без жизненно важных ресурсов. Придется объясняться перед Советом..."},{name:"Аквария",eggQuota:125,distance:200,successChangeRating:10,failChangeRating:-10,task:"Планета: Аквария (Водный мир). Требуется 125 яиц для плавучих городов-архипелагов. Местное население страдает от дефицита белка из-за ограниченности земельных ресурсов. Ваш груз поможет стабилизировать пищевую ситуацию на планете.",success:"УСПЕХ! Аквария: Груз доставлен! Плавучие города спасены от белкового голодания.",fail:"ПРОВАЛ! Аквария: Груз не доставлен! Население водного мира продолжает страдать от дефицита белка. Летим дальше с пустыми трюмами."},{name:"Гелиос-Прайм",eggQuota:250,distance:300,successChangeRating:15,failChangeRating:-15,task:"Планета: Гелиос-Прайм (Приполярная зона). Срочно доставьте 250 яиц в криогенной упаковке для полярных исследовательских станций. Экстремальные температуры требуют особых условий транспортировки и максимальной свежести продукции.",success:"УСПЕХ! Гелиос-Прайм: Миссия выполнена! Полярные исследователи обеспечены провизией.",fail:"ПРОВАЛ! Гелиос-Прайм: Миссия провалена! Исследователи остались без провизии в ледяной пустыне. Время не ждет - движемся к следующей цели."},{name:"Терра-Нова",eggQuota:400,distance:400,successChangeRating:20,failChangeRating:-20,task:"Планета: Терра-Нова (Землеподобный мир). Финальная миссия - 400 яиц для восстановления биосферы после экологической катастрофы. Ваш вклад поможет реанимировать планетарную экосистему и дать начало новой цивилизации.",success:"УСПЕХ! Терра-Нова: Финальный груз доставлен! Биосфера планеты спасена. Вы стали героем Галактического Совета!",fail:"ПРОВАЛ! Терра-Нова: Финальная миссия сорвана! Шанс восстановить планету упущен. Ваша репутация серьезно пострадала."}]);o(this,"eventTimer",0);o(this,"eventAnswers",[]);o(this,"events",[{name:"Поломка системы климат-контроля",description:"В инкубаторе отказала система поддержания температуры. Эмбрионы могут погибнуть.",question:"Как спасти инкубационную партию?",image:"public/images/events/event_1.jpg",variants:[{answer:"Экстренно перенести яйца в резервный инкубатор",comment:"Потеря 10% яиц при переносе, задержка цикла на 1 день.",correct:!0,changeRating:5},{answer:"Вручную регулировать температуру с помощью аварийных нагревателей",comment:"Риск человеческой ошибки (50% шанс потери всей партии).",correct:!1,changeRating:-5},{answer:"Увеличить температуру во всем модуле на 2°C",comment:"Перегрев 60% эмбрионов, рождение нежизнеспособных цыплят.",correct:!1,changeRating:-20},{answer:"Смириться с потерей и начать новую закладку",comment:"-100% текущей партии, но минимальные затраты на запуск нового цикла.",correct:!0,changeRating:10}]},{name:"Обнаружение бракованной партии яиц",description:"В цехе сортировки выявлена партия яиц с микротрещинами скорлупы.",question:"Как поступить с бракованной продукцией?",image:"public/images/events/event_2.jpg",variants:[{answer:"Отправить на переработку в корм для животных",comment:"+15% к производству корма, но потеря доходов от продажи.",correct:!0,changeRating:10},{answer:"Реализовать со скидкой 70% как продукцию второго сорта",comment:"+30% дохода vs риск репутационных потерь.",correct:!1,changeRating:-15},{answer:"Утилизировать как биологические отходы",comment:"Полная потеря продукции и затраты на утилизацию.",correct:!1,changeRating:-20},{answer:"Отправить на дополнительную обработку и герметизацию",comment:"+80% сохраненной продукции, но дополнительные затраты на обработку.",correct:!0,changeRating:15}]},{name:"Конфликт экологии и эффективности",description:"Новый стимулятор роста обещает +25% к яйценоскости, но может навредить экобалансу фермы.",question:"Использовать ли новый препарат?",image:"public/images/events/event_3.jpg",variants:[{answer:"Применить ко всему поголовью для максимизации прибыли",comment:"+25% производства, но -30% к качеству яиц и -15% к здоровью кур.",correct:!1,changeRating:-5},{answer:"Использовать только в критических ситуациях",comment:"+10% производства при редком использовании, минимальный экологический ущерб.",correct:!1,changeRating:-10},{answer:"Отказаться в пользу экологичных методов",comment:"Сохранение экобаланса, +5% к качеству яиц за счет натуральности.",correct:!0,changeRating:10},{answer:"Провести дополнительные испытания на малой группе",comment:"Задержка внедрения на 5 дней, но точные данные о последствиях.",correct:!0,changeRating:20}]}]);o(this,"isDraggableObjectActive",!1);o(this,"isReadingHelper",!1);o(this,"rating",50);o(this,"money",2e4);o(this,"chickenBreed",m.CHICKEN_BREED_STANDARD);o(this,"chickenBreedQuality",{[m.CHICKEN_BREED_STANDARD]:5,[m.CHICKEN_BREED_PRO]:20});o(this,"chickenBreedNames",{[m.CHICKEN_BREED_STANDARD]:"Обычная курица",[m.CHICKEN_BREED_PRO]:"Продвинутая курица"});o(this,"eggQualityClasses",{[m.EGG_QUALITY_C3]:0,[m.EGG_QUALITY_C2]:30,[m.EGG_QUALITY_C1]:60,[m.EGG_QUALITY_C0]:100});o(this,"eggQualityMoney",{[m.EGG_QUALITY_C3]:50,[m.EGG_QUALITY_C2]:60,[m.EGG_QUALITY_C1]:70,[m.EGG_QUALITY_C0]:80});o(this,"cleanViolation",!1);o(this,"feedingViolation",!1);o(this,"conditionViolation",!1);o(this,"violations",{clean:{success:{changeQuality:10},fail:{changeRating:-10,changeQuality:-10}},feeding:{success:{changeQuality:20},fail:{changeRating:-20,changeQuality:-20}},condition:{success:{changeQuality:30},fail:{changeRating:-30,changeQuality:-30}}});if(m.instance)throw new Error("GameState class: use getInstance() method instead.")}static getInstance(){return m.instance||(m.instance=new m),m.instance}reset(){this.passedTime=0,this.limitTime=100,this.frozenEggs=0,this.currentMission=-1,this.manure=0,this.eggshell=0,this.food=500,this.rating=50,this.eventTimer=0,this.eventAnswers=[];for(const t of this.rooms)t.resetRoom();this.resetViolations()}addRoom(t){this.rooms.push(t)}deleteRoom(t){const e=this.rooms.indexOf(t);this.rooms.splice(e,1)}addDrone(t){this.drones.push(t)}getChickenBreedName(){return this.chickenBreedNames[this.chickenBreed]}getEggQualityInfo(){return{chickenBreed:this.chickenBreedQuality[this.chickenBreed],cleanViolation:this.cleanViolation?this.violations.clean.fail.changeQuality:this.violations.clean.success.changeQuality,feedingViolation:this.feedingViolation?this.violations.feeding.fail.changeQuality:this.violations.feeding.success.changeQuality,chickenConditionViolation:this.conditionViolation?this.violations.condition.fail.changeQuality:this.violations.condition.success.changeQuality}}getEggQuality(){return Object.values(this.getEggQualityInfo()).reduce((t,e)=>t+e,0)}getEggQualityClass(){const t=this.getEggQuality();let e=m.EGG_QUALITY_C3;for(const[s,r]of Object.entries(this.eggQualityClasses))r<t&&(e=s);return e}getEggQualityCost(t=null){return t=t||this.getEggQualityClass(),this.eggQualityMoney[t]}getEggQualityPoint(t=null){return t=t||this.getEggQualityClass(),this.eggQualityClasses[t]}getNextEggQualityClass(t=null){t=t||this.getEggQualityClass();const e=Object.keys(this.eggQualityClasses),s=e.indexOf(t);return s===-1||s===e.length-1?null:e[s+1]}getShipConfig(){return this.shipsConfig[this.currentShip]}buy(t){return this.money<t?(showModal("Недостаточно денег"),!1):(this.money-=t,!0)}getHeroAnswer(t){const e=Math.floor(Math.random()*this.heroAnswers[t].length);return this.heroAnswers[t][e]}getRandomEventId(){const t=this.eventAnswers.map(s=>s.event);let e=Array.from(this.events.keys());return e=e.filter(s=>!t.includes(s)),e[Math.floor(Math.random()*e.length)]}getEventCorrectAnswer(t){const e=this.events[t];for(const s of e.variants)if(s.correct)return s.answer;return null}changeRating(t){this.rating+=t,this.rating=Math.min(this.rating,100),this.rating=Math.max(this.rating,0)}resetViolations(){this.cleanViolation=!1,this.feedingViolation=!1,this.conditionViolation=!1}};o(m,"instance"),o(m,"CRITICAL_FOOD",0),o(m,"CRITICAL_POLLUTION",75),o(m,"CRITICAL_RATING",0),o(m,"EMPTY_ROOM_TYPE","empty_room_type"),o(m,"SORTING_ROOM_TYPE","sorting_room_type"),o(m,"INCUBATOR_ROOM_TYPE","incubator_room_type"),o(m,"NURSERY_ROOM_TYPE","nursery_room_type"),o(m,"COOP_ROOM_TYPE","coop_room_type"),o(m,"FARM_ROOM_TYPE","farm_room_type"),o(m,"EVENT_TIMER_MAX",200),o(m,"EVENT_TIMER_MIN",50),o(m,"CHICKEN_BREED_STANDARD","chicken_breed_standard"),o(m,"CHICKEN_BREED_PRO","chicken_breed_pro"),o(m,"EGG_QUALITY_C3","C3"),o(m,"EGG_QUALITY_C2","C2"),o(m,"EGG_QUALITY_C1","C1"),o(m,"EGG_QUALITY_C0","C0");let f=m;class Tt extends v{constructor(){super(...arguments);o(this,"minSize",100);o(this,"maxSize",125);o(this,"onClickCallback");o(this,"clickSound","public/sounds/click.mp3");o(this,"originalImage",null)}init(){this.onReady(this.onReadyCallback.bind(this)),this.forever(this.control)}control(){this.touchMouse()?f.getInstance().isDraggableObjectActive||(this.size=(this.maxSize-this.size)/3,this.game.mouseDownOnce()&&this.onClickCallback&&(this.clickSound&&this.playSound("click",{volume:.05}),this.onClickCallback())):this.size=(this.minSize-this.size)/3}onReadyCallback(){this.clickSound&&this.addSound(this.clickSound,"click")}onClick(e){this.onClickCallback=e.bind(e.context)}setLabel(e,s="white",r=72){const n=this.getCostume().image,h=n.getContext("2d");this.originalImage||(this.originalImage=this.createOriginalImage()),h.drawImage(this.originalImage,-n.width/2,-n.height/2),h.font=r+"px Arial",h.fillStyle=s,h.textAlign="center",h.fillText(e,0,15)}createOriginalImage(){const e=this.getCostume().image,s=document.createElement("canvas"),r=s.getContext("2d");return s.width=e.width,s.height=e.height,r.drawImage(e,0,0),s}}class A extends Tt{constructor(){super(...arguments);o(this,"minSize",100);o(this,"maxSize",125)}init(){this.addCostume("public/images/ui/button.png"),super.init()}}class oe extends v{constructor(){super(...arguments);o(this,"startY",700);o(this,"shouldShow",!1);o(this,"speed",8);o(this,"active",!1);o(this,"currentText","");o(this,"currentTextIndex",0);o(this,"needText","");o(this,"imageTick",0);o(this,"imageTickSpeed",6);o(this,"showPerson",!1);o(this,"currentPerson",null);o(this,"readyCallback",null);o(this,"readyText","")}init(){this.drawCostume(e=>{e.fillRect(0,0,800,200)},{width:800,height:200}),this.nextButton=new A,this.nextButton.x=this.game.width-this.nextButton.width/2-100,this.nextButton.y=this.game.height-this.nextButton.height/2-50,this.nextButton.hidden=!0,this.personImage=new v,this.personImage.x=100,this.personImage.y=500,this.personImage.size=27,this.personImage.hidden=!0,this.layer=10,this.nextButton.layer=11,this.personImage.layer=11,this.y=700,this.forever(this.control),this.pen(this.showText.bind(this),this.layer+1)}control(){this.shouldShow?this.y>this.startY-200?this.y-=this.speed:(this.y=this.startY-200,this.active=!0,this.nextButton.hidden=!1,this.showPerson&&(this.personImage.hidden=!1)):this.y<this.startY?this.y+=this.speed:this.y=this.startY}onReadyCallback(){}onClick(e,s=""){this.readyCallback=e.bind(this),s&&(this.readyText=s)}setReady(){this.readyCallback?this.nextButton.onClick(this.readyCallback):this.nextButton.onClick(this.hide),this.readyText?this.nextButton.setLabel(this.readyText):this.nextButton.setLabel("")}setButtonText(e){this.readyText=e}showText(e){this.active&&(this.currentTextIndex<this.needText.length?(this.currentText+=this.needText[this.currentTextIndex],this.currentTextIndex+=1,this.imageTick+=1,this.imageTick>=this.imageTickSpeed&&(this.personImage.nextCostume(),this.imageTick=0)):(this.personImage.switchCostume(0),this.setReady()),e.fillStyle="#ffffff",e.font="20px Arial",this.showPerson?this.drawMultilineText(e,this.currentText,200,450,550,30):this.drawMultilineText(e,this.currentText,50,450,700,30))}show(e,s=null,r="Normal"){f.getInstance().isReadingHelper=!0,this.shouldShow=!0,this.currentText="",this.currentTextIndex=0,this.needText=e,this.showPerson=s!=null,s&&this.currentPerson!=s+r&&(this.clearPersonCostumes(),this.setPerson(s,r)),this.nextButton.onClick(()=>{this.currentTextIndex=this.needText.length,this.currentText=this.needText}),this.nextButton.setLabel("Пропустить")}hide(){f.getInstance().isReadingHelper=!1,this.shouldShow=!1,this.active=!1,this.nextButton.hidden=!0,this.personImage.hidden=!0,this.showPerson=!1}drawMultilineText(e,s,r,n,h,a){const u=s.split(" ");let l="",c="",d=[];for(let g=0;g<u.length;g++)c=l+u[g]+" ",e.measureText(c).width>h&&g>0?(d.push(l.trim()),l=u[g]+" "):l=c;d.push(l.trim());for(let g=0;g<d.length;g++)e.fillText(d[g],r,n+g*a)}clearPersonCostumes(){if(this.personImage.getCostume()!=null)for(;this.personImage.getCostume()!=null;)this.personImage.removeCostume(this.personImage.getCostumeIndex())}setPerson(e,s){for(const r of f.getInstance().personAnimations[e+s])this.personImage.addCostume(r);this.currentPerson=e+s}}class he extends v{init(){this.fps=0,this.frameCount=0,this.lastTime=performance.now(),this.forever(this.control),this.pen(this.drawCount)}control(){this.frameCount++;const t=performance.now();t>=this.lastTime+1e3&&(this.fps=this.frameCount,this.frameCount=0,this.lastTime=t)}drawCount(t,e){t.fillStyle="#ffffff",t.font="16px Arial",t.fillText(`FPS: ${e.fps}`,e.x,e.y)}}class wt extends Ht{init(){this.mainResousesPanel=new v,this.mainResousesPanel.addCostume("public/images/icons/top_panel_base.png"),this.mainResousesPanel.y=550,this.mainResousesPanel.leftX=300,this.mainResousesPanel.size=70,this.mainResousesPanel.layer=9,this.egs=new v,this.egs.addCostume("public/images/icons/resources/egg.png"),this.egs.x=50,this.egs.y=550,this.egs.size=90,this.egs.layer=10,this.chick=new v,this.chick.addCostume("public/images/icons/resources/small_chicken.png"),this.chick.x=120,this.chick.y=550,this.chick.size=90,this.chick.layer=10,this.chicken=new v,this.chicken.addCostume("public/images/icons/resources/chicken.png"),this.chicken.x=190,this.chicken.y=550,this.chicken.size=90,this.chicken.layer=10,this.eat=new v,this.eat.addCostume("public/images/icons/resources/eat.png"),this.eat.x=260,this.eat.y=550,this.eat.size=90,this.eat.layer=10,this.shit=new v,this.shit.addCostume("public/images/icons/resources/shit.png"),this.shit.x=350,this.shit.y=550,this.shit.size=90,this.shit.layer=10,this.crash=new v,this.crash.addCostume("public/images/icons/resources/crash.png"),this.crash.x=420,this.crash.y=550,this.crash.size=90,this.crash.layer=10,this.pen(this.drawParameters.bind(this),10),this.helper=new oe,this.helper.onClick(this.helper.hide),this.game.showFps&&this.createFpsCounter()}drawMultilineText(t,e,s,r,n,h){const a=e.split(" ");let u="",l="",c=[];for(let d=0;d<a.length;d++)l=u+a[d]+" ",t.measureText(l).width>n&&d>0?(c.push(u.trim()),u=a[d]+" "):u=l;c.push(u.trim());for(let d=0;d<c.length;d++)t.fillText(c[d],s,r+d*h)}drawResoursesPanel(){new v().addCostume("public/images/icons/top_panel_base.png")}drawParameters(t){t.font="18px Arial",t.fillStyle="#4444ff",t.textAlign="start",t.fillText(f.getInstance().frozenEggs,70,555),t.fillText(f.getInstance().chick,140,555),t.fillText(f.getInstance().chicken,210,555),t.fillText(f.getInstance().food.toFixed(1),280,555),t.fillText(f.getInstance().manure,370,555),t.fillText(f.getInstance().eggshell,440,555)}createFpsCounter(){const t=new he(this,10);t.x=720,t.y=545}}class Mt extends wt{constructor(){super(...arguments);o(this,"currentSlide",0);o(this,"slides",[]);o(this,"textBlockHeight",200);o(this,"textBlockReady",!1);o(this,"currentTextBlockHeight",0);o(this,"slideTimer",0);o(this,"nextButtonLabel","Далее")}init(){this.nextButton=new A,this.nextButton.layer=4,this.nextButton.minSize=90,this.nextButton.maxSize=110,this.nextButton.x=this.width-80,this.nextButton.y=this.height-30,this.nextButton.hidden=!0,this.nextButton.onClick(this.nextSlide.bind(this)),this.nextButton.onReady(()=>{this.nextButton.setLabel(this.nextButtonLabel,"white",64)}),this.pen(this.drawTextBlock.bind(this))}drawTextBlock(e){if(this.slides[this.currentSlide]&&(this.slideTimer++,!(this.slideTimer<35)))if(e.fillStyle="rgba(0, 0, 0, 0.9)",e.fillRect(0,this.height-this.currentTextBlockHeight,this.width,this.currentTextBlockHeight),this.currentTextBlockHeight>=this.textBlockHeight){e.font="18px Arial",e.fillStyle="white";const s=this.slides[this.currentSlide].text;this.drawMultilineText(e,s,20,this.height-this.currentTextBlockHeight+30,this.width-40,22),this.textBlockReady||(this.nextButton.hidden=!1),this.textBlockReady=!0}else this.currentTextBlockHeight+=5}nextSlide(){this.currentSlide++,this.onNextSlide()}reset(){this.currentSlide=0,this.textBlockReady=!1,this.currentTextBlockHeight=0,this.slideTimer=0,this.startButton.hidden=!0}}class Gt extends Tt{constructor(){super(...arguments);o(this,"minSize",400);o(this,"maxSize",415);o(this,"active",!1)}init(){this.drawCostume(()=>{}),super.init()}activate(){this.active||(this.filter="grayscale(0)",this.active=!0)}deactivate(){this.filter="grayscale(100%)",this.active=!1}}class q extends wt{constructor(){super(...arguments);o(this,"thumbnail");o(this,"pollution",0);o(this,"isRoomReady",!1);o(this,"tickMaxCount",5);o(this,"tickCount",0);o(this,"maxQuantity",20);o(this,"currentQuantity",0);o(this,"isFirstUse",!1);o(this,"cleaningValue",5);o(this,"robot",null);o(this,"robotChargeDif",0);o(this,"isCleaningByRobot",!1)}init(){super.init(),this.gameState=f.getInstance(),this.onReady(()=>{this.monitorStage=D.getInstance()}),this.addBackground("public/images/common/main_monitor.png"),this.addSound("public/sounds/ready.mp3","ready"),this.addSound("public/sounds/activation.mp3","activation"),this.bgSpace=new v,this.bgSpace.addCostume("public/images/rooms/background_space.png"),this.bgSpace.leftX=300,this.bgSpace.layer=3,this.bgStar=new v,this.bgStar.addCostume("public/images/rooms/star.png"),this.bgStar.hidden=!0,this.backgroundSprite=new v,this.backgroundSprite.addCostume(this.getBackgroundImage()),this.backgroundSprite.layer=5,this.backgroundSprite.x=300,this.backgroundSprite.y=300,this.createBackButton(),this.createInstructionButton(),this.createGetManureButton(),this.forever(this.gameTickAllRooms,1e3),this.visualiser=new v,this.setVisCostumes(),this.visualiser.hidden=!0,this.visualiser.moving=!0,this.forever(this.spawStars,2),this.pen(this.drawHelpBlock.bind(this)),this.onStart(()=>{this.visualizerSpawn(),this.isFirstUse&&this.gameState.teachingMode&&(this.helper.show(this.getHelpText(),"Boss"),this.helper.setButtonText("Дальше"),this.helper.onClick(()=>{this.showInstructionDialog()}))}),this.onReady(()=>{this.resetRoom()})}createGetManureButton(){const e=new A(this,5);e.x=320,e.y=490,e.onReady(()=>{e.setLabel("Собрать помет",void 0,70)}),e.onClick(()=>{this.gameState.manure+=Math.floor(this.pollution*.5),this.pollution=0}),e.forever(()=>{this.pollution>=1?e.hidden=!1:e.hidden=!0})}createBackButton(){const e=new A;e.layer=10,e.x=690,e.y=130,e.onReady(()=>{e.setLabel("Назад")}),e.onClick(()=>{this.helper.active&&this.helper.hide(),this.game.run(D.getInstance())})}createInstructionButton(){const e=new A;e.layer=8,e.minSize=70,e.maxSize=80,e.x=655,e.y=540,e.onReady(()=>{e.setLabel("Помощь")}),e.onClick(()=>{this.showInstructionDialog()})}showInstructionModal(){showModal(this.getInstructionText(),()=>this.stop(),()=>this.run())}getRoomType(){console.error("Метод не определен.")}getRoomConfig(){return this.gameState.roomsConfig[this.getRoomType()]}getRoomConfigParam(e){return this.getRoomConfig()[e]}getLabel(){return this.getRoomConfigParam("name")}getHelpText(){return this.getRoomConfigParam("helpText")}getInstructionText(){return this.getRoomConfigParam("instructionText")}getBackgroundImage(){return this.getRoomConfigParam("backgroundImage")}getThumbnailImage(){return this.getRoomConfigParam("thumbnailImage")}getShopImage(){return this.getRoomConfigParam("shopImage")}getCost(){return this.getRoomConfigParam("cost")}resetRoom(){this.currentQuantity=0,this.isRoomReady=!1,this.pollution=0}roomTick(){this.robot&&(this.pollution-=this.cleaningValue,this.robot.charge-=this.robotChargeDif,this.robot.charge<=0&&(this.robot=null),this.pollution<=0&&(this.pollution=0)),this.pollution>=100&&(this.pollution=100)}setThumbnail(e){this.thumbnail=e}gameTickAllRooms(){D.getInstance().gameTick()}visualizerSpawn(){this.visualiser.deleteClones();for(let e=0;e<this.currentQuantity;e++){let s=this.visualiser.createClone();s.hidden=!1,s.x=this.game.getRandom(200,400),s.y=this.game.getRandom(200,400),s.layer=10,s.rotateStyle="leftRight",s.size=150,s.xSpeed=this.game.getRandom(-10,10)/10,s.ySpeed=this.game.getRandom(-10,10)/10;let r=this.game.getRandom(0,this.visualiser.costumes.length);s.switchCostume(r),this.visualiser.moving&&s.forever(function(){s.x+=s.xSpeed,s.y+=s.ySpeed,s.xSpeed>0?s.direction=-90:s.direction=90,s.x>400&&(s.xSpeed*=-1),s.x<100&&(s.xSpeed*=-1),s.y>400&&(s.ySpeed*=-1),s.y<200&&(s.ySpeed*=-1)})}}setVisCostumes(){}spawStars(){let e=this.bgStar.createClone();e.x=575,e.y=this.game.getRandom(30,570),e.layer=4,e.size=this.game.getRandom(50,100),e.hidden=!1,e.forever(function(){e.x-=e.size/20,e.x<30&&e.delete()})}drawHelpBlock(e){e.textAlign="left",e.font="bold 18px Arial",e.fillStyle="#a8e2c0ff",e.fillText("Справка:",610,400),e.font="14px Arial",this.drawMultilineText(e,this.getHelpText(),610,430,165,20)}showInstructionDialog(){this.helper.show(this.getInstructionText(),"Boss"),this.helper.setButtonText("Дальше"),this.helper.onClick(()=>{this.helper.show(f.getInstance().getHeroAnswer("Normal")+", босс!","Hero"),this.helper.setButtonText("Конец"),this.isFirstUse=!1,this.helper.onClick(()=>{this.helper.hide()})})}}const F=class F extends q{constructor(){super(...arguments);o(this,"inProgress",!1);o(this,"currentProgress",0);o(this,"currentReadyProgress",0);o(this,"tickMaxCount",0)}init(){super.init(),this.forever(this.control()),this.pen(this.drawParameters,4),this.moveButton=new A(this,5),this.moveButton.x=160,this.moveButton.y=490,this.moveButton.hidden=!0,this.visualiser.moving=!1,this.moveButton.onReady(()=>{this.moveButton.setLabel("Цыплят в ясли",void 0,70)}),this.moveButton.onClick(()=>{let e=.02*Math.floor(this.pollution/10),s=Math.round(this.currentQuantity*(.9-e));for(let r=0;r<this.gameState.rooms.length;r++)if(this.gameState.rooms[r].getRoomType()===f.NURSERY_ROOM_TYPE){const n=this.gameState.rooms[r];if(!n.inProgress)return n.inProgress=!0,n.currentQuantity=s,this.gameState.eggshell+=Math.floor(s/2),this.failRoom(),this.visualizerSpawn(),!0}})}control(){return()=>{this.isRoomReady?this.moveButton.hidden=!1:this.moveButton.hidden=!0}}getRoomType(){return f.INCUBATOR_ROOM_TYPE}resetRoom(){super.resetRoom(),this.inProgress=!1,this.currentProgress=0,this.currentReadyProgress=0}failRoom(){this.inProgress=!1,this.currentProgress=0,this.currentReadyProgress=0,this.currentQuantity=0,this.isRoomReady=!1}roomTick(){super.roomTick(),this.inProgress&&(this.tickCount+=1,this.tickCount>this.tickMaxCount&&(this.tickCount=0,this.currentProgress+=1,this.currentProgress>=F.INCUBATOR_CYCLE_TIMER&&(this.currentProgress=F.INCUBATOR_CYCLE_TIMER,this.isRoomReady||this.playSound("ready",.5),this.isRoomReady=!0)),this.isRoomReady&&(this.currentReadyProgress+=1,this.currentReadyProgress>F.INCUBATOR_READY_LIMIT&&(this.pollution+=Math.round(this.currentQuantity*.4))),this.pollution=Math.min(this.pollution,100))}drawParameters(e,s){super.drawParameters(e),e.font="16px Arial",e.fillStyle="white",e.textAlign="start",e.fillText("Сколько яиц: "+s.currentQuantity+" шт.",610,190),e.fillText("Вместимость: "+s.maxQuantity+" шт.",610,215),e.fillText("Загрязненность: "+s.pollution+"%",610,240),e.fillText("Готовность: "+s.currentProgress/F.INCUBATOR_CYCLE_TIMER*100+"%",610,265)}setVisCostumes(){super.setVisCostumes(),this.visualiser.addCostume("public/images/sprites/egg/egg_1.png"),this.visualiser.addCostume("public/images/sprites/egg/egg_2.png"),this.visualiser.addCostume("public/images/sprites/egg/egg_3.png")}drawHelp(e){super.drawHelp(e)}};o(F,"INCUBATOR_CYCLE_TIMER",10),o(F,"INCUBATOR_READY_LIMIT",10);let bt=F;class le extends v{init(){this.addCostume("public/images/sprites/drone/drone_charging.png"),this.size=100,this.filter="grayscale(100%)",this.forever(this.logic)}logic(){}}class ue{static build(t,e,s,r,n=5){e.getLabel();const h=e.getThumbnailImage(),a=new Gt(t,1,[h]);if(a.x=s,a.y=r,e.getRoomType()!==f.EMPTY_ROOM_TYPE){const u=new le(t);u.x=s-30,u.y=r-15,u.layer=4,u.addTag("cleanStation"),u.size=40,u.room=e}return e.robotChargeDif=n,e.setThumbnail(a),a.onReady(()=>{}),a.onClick(()=>{t.game.run(e)}),a.forever(()=>{a.touchMouse()&&t.showHelp(e.getHelpText())}),a}}class ce extends v{constructor(){super(...arguments);o(this,"minSize",18);o(this,"maxSize",20);o(this,"onClickCallback");o(this,"active",!1);o(this,"canMove",!0);o(this,"drawValue",!1);o(this,"currentValue",0)}init(){this.forever(this.control),this.pen(this.setLabel.bind(this),4)}control(){this.touchMouse()&&this.game.mouseDown()&&!f.getInstance().isDraggableObjectActive&&(this.active=!0,f.getInstance().isDraggableObjectActive=!0),this.game.mouseDown()||(this.active=!1,f.getInstance().isDraggableObjectActive=!1),this.active&&this.canMove&&(this.x=this.game.getMousePoint().x,this.y=this.game.getMousePoint().y)}setLabel(e){this.drawValue&&(e.font="10px Arial",e.fillStyle="white",e.textAlign="center",e.fillText(this.currentValue,this.x,this.y+3))}}class de extends ce{constructor(){super(...arguments);o(this,"minSize",1400);o(this,"maxSize",1800);o(this,"charge",100);o(this,"isCharging",!1);o(this,"startX",0);o(this,"startY",0);o(this,"stationRoom",null)}init(){this.addCostume("public/images/sprites/drone/drone_active.png"),this.addCostume("public/images/sprites/drone/drone_charging.png"),this.size=75,super.init()}control(){if(super.control(),this.charge>=100&&(this.charge=100),this.charge<=0?(this.charge=0,this.switchCostume(1)):this.switchCostume(0),this.drawValue=this.touchMouse(),this.touchMouse()&&this.game.mouseDown())this.size=75,this.stationRoom&&(this.stationRoom.robot=null,this.stationRoom=null);else if(this.touchTag("cleanStation")&&this.charge>0){const e=this.otherSprite;e.room.isCleaning=!0,this.stationRoom=e.room,this.stationRoom.robot=this,this.x=e.x,this.y=e.y,this.size=e.size,this.isCharging=!1}else this.x=this.startX,this.y=this.startY,this.isCharging=!0,this.size=75,this.stationRoom&&(this.stationRoom.robot=null,this.stationRoom=null)}setStartPos(){this.startX=this.x,this.startY=this.y}setLabel(e,s){s.drawValue&&(e.font="16px Arial",e.fillStyle="#fff",e.textAlign="center",e.fillText(s.charge,s.x,s.y-7))}}const X=class X extends Mt{constructor(){super();o(this,"textBlockHeight",180);o(this,"nextButtonLabel","Задание");if(X.instance)throw new Error("MissionStage class: use getInstance() method instead.");this.gameState=f.getInstance()}static getInstance(){return X.instance||(X.instance=new X),X.instance}init(){super.init(),this.addBackground("public/images/missions/mission_0.jpg"),this.addBackground("public/images/missions/mission_1.jpg"),this.addBackground("public/images/missions/mission_2.jpg"),this.addBackground("public/images/missions/mission_3.jpg"),this.addBackground("public/images/missions/mission_4.jpg"),this.addBackground("public/images/missions/mission_0.jpg"),this.startButton=new A,this.startButton.layer=4,this.startButton.minSize=90,this.startButton.maxSize=110,this.startButton.x=this.width-80,this.startButton.y=this.height-30,this.startButton.hidden=!0,this.startButton.onClick(this.runGame.bind(this)),this.startButton.onReady(()=>{this.startButton.setLabel("Принято!")})}setMissionSlides(e,s,r=null,n=null,h=null,a=null,u=null){this.reset(),this.switchBackground(e+1),this.slides=[],a!==null&&this.slides.push({text:a});const l=this.gameState.missions[e];if(l!==void 0){const g=s?l.success:l.fail;g!==void 0&&this.slides.push({text:g})}if(r!==null&&n!==null&&h!==null){let g="Мы продали: "+r+" яиц и заработали "+n+"$. ";h>0?g+="Наш рейтинг увеличился на "+h+".":h<0?g+="Наш рейтинг уменьшился на "+h+".":g+="Это не повлияло на наш рейтинг.",this.slides.push({text:g})}const c=e+1,d=this.gameState.missions[c];d!==void 0?this.slides.push({text:d.task}):this.startButton.onClick(this.restartGame.bind(this)),u!==null&&this.slides.push({text:u})}onNextSlide(){this.currentSlide===this.slides.length-1&&(this.nextButton.hidden=!0,this.startButton.hidden=!1)}runGame(){this.game.run(D.getInstance())}restartGame(){D.getInstance().restartGame(),this.game.run(K.getInstance())}};o(X,"instance");let st=X;class ge extends Tt{constructor(){super(...arguments);o(this,"minSize",200);o(this,"maxSize",225)}init(){this.addCostume("public/images/icons/info.png"),super.init()}}class Wt extends v{constructor(){super(...arguments);o(this,"minSize",18);o(this,"maxSize",20);o(this,"onClickCallback");o(this,"active",!1);o(this,"canMove",!0);o(this,"lessColor","white");o(this,"moreColor","white");o(this,"drawLine",!0);o(this,"drawValue",!0);o(this,"currentValue",0);o(this,"minValue",0);o(this,"maxValue",100);o(this,"minX",0);o(this,"maxX",0)}init(){this.forever(this.control),this.stage.pen((e,s)=>{this.drawLine&&(e.lineWidth=3,e.strokeStyle=this.lessColor,e.beginPath(),e.moveTo(this.x,this.y),e.lineTo(this.minX,this.y),e.stroke(),e.strokeStyle=this.moreColor,e.beginPath(),e.moveTo(this.x,this.y),e.lineTo(this.maxX,this.y),e.stroke())},10),this.pen(this.setLabel,10)}control(){this.touchMouse()&&this.game.mouseDown()&&(this.active=!0,f.getInstance().isDraggableObjectActive=!0),this.game.mouseDown()||(this.active=!1,f.getInstance().isDraggableObjectActive=!1),this.active&&(this.canMove&&(this.x=this.game.getMousePoint().x),this.x>this.maxX&&(this.x=this.maxX),this.x<this.minX&&(this.x=this.minX),this.setCurrentValue()),this.maxValue<this.minValue&&(this.maxValue=this.minValue)}setLabel(e,s){s.drawValue&&(e.font="10px Arial",e.fillStyle="white",e.textAlign="center",e.fillText(s.currentValue,s.x,s.y+3))}setWidth(e){this.minX=this.x-e/2,this.maxX=this.x+e/2,this.currentValue=(this.maxValue-this.minValue)/2}setCurrentValue(e=this.currentValue){if(this.currentValue=e,this.currentValue>this.maxValue&&(this.currentValue=this.maxValue),this.currentValue<this.minValue&&(this.currentValue=this.minValue),this.canMove)this.currentValue=Math.round((this.x-this.minX)/(this.maxX-this.minX)*this.maxValue);else{const s=this.maxValue==this.minValue?0:(this.currentValue-this.minValue)/(this.maxValue-this.minValue)*(this.maxX-this.minX);this.x=Math.round(this.minX+s)}}}class me extends Wt{constructor(){super(...arguments);o(this,"minSize",18);o(this,"maxSize",20)}init(){this.addCostume("public/images/ui/button.png"),this.addCostume("public/images/icons/space_progress/ship_1.png"),super.init()}}class pe extends q{constructor(){super(...arguments);o(this,"maxQuantity",100)}init(){super.init(),this.nextStage="Инкубатор",this.quantitySlider=new me,this.quantitySlider.layer=10,this.quantitySlider.size=15,this.quantitySlider.x=260,this.quantitySlider.y=200,this.quantitySlider.setWidth(200),this.coolerButton=new A,this.coolerButton.minSize=90,this.coolerButton.maxSize=100,this.coolerButton.onClick(()=>{const e=this.quantitySlider.currentValue;e!==0&&(this.gameState.frozenEggs+=Math.floor(e*.9),this.currentQuantity-=e,this.quantitySlider.maxValue=this.currentQuantity,this.quantitySlider.setCurrentValue())}),this.coolerButton.x=290,this.coolerButton.y=300,this.coolerButton.layer=10,this.coolerButton.onReady(()=>{this.coolerButton.setLabel("Холодильник",void 0,70)}),this.incubatorButton=new A,this.incubatorButton.minSize=90,this.incubatorButton.maxSize=100,this.incubatorButton.onClick(()=>{const e=this.quantitySlider.currentValue;if(e!==0){for(let s=0;s<this.gameState.rooms.length;s++)if(this.gameState.rooms[s].getRoomType()===f.INCUBATOR_ROOM_TYPE){const r=this.gameState.rooms[s];if(!r.inProgress)return r.inProgress=!0,r.currentQuantity=Math.floor(e*.95),this.currentQuantity-=e,this.quantitySlider.maxValue=this.currentQuantity,this.quantitySlider.setCurrentValue(),!0}return showModal("Нет готовых инкубаторов",()=>this.stop(),()=>this.run()),!1}}),this.incubatorButton.x=500,this.incubatorButton.y=200,this.incubatorButton.layer=10,this.incubatorButton.onReady(()=>{this.incubatorButton.setLabel("Инкубатор",void 0,70)}),this.quantitySlider.hidden=!0,this.coolerButton.hidden=!0,this.incubatorButton.hidden=!0,this.forever(this.control()),this.pen(this.drawParameters,10)}control(){return()=>{}}getRoomType(){return f.SORTING_ROOM_TYPE}resetRoom(){super.resetRoom(),this.currentQuantity=20,this.quantitySlider.hidden=!1,this.coolerButton.hidden=!1,this.incubatorButton.hidden=!1}roomTick(){super.roomTick(),this.tickCount+=1,this.tickCount>this.tickMaxCount&&(this.tickCount=0),this.currentQuantity>this.maxQuantity&&(this.currentQuantity=this.maxQuantity),this.isRoomReady=this.currentQuantity>=this.maxQuantity,this.quantitySlider.maxValue=this.currentQuantity,this.quantitySlider.setCurrentValue(),this.pollution=Math.min(this.pollution,100)}drawParameters(e,s){super.drawParameters(e),e.font="16px Arial",e.fillStyle="white",e.textAlign="start",e.fillText("Количество яиц: "+s.currentQuantity+" шт.",610,190),e.fillText("Вместимость: "+s.maxQuantity+" шт.",610,215),e.fillText("Загрязненность: "+s.pollution+"%",610,240)}drawHelp(e){super.drawHelp(e)}}class _e extends q{constructor(){super(...arguments);o(this,"maxQuantity",100);o(this,"rooms",[f.INCUBATOR_ROOM_TYPE,f.NURSERY_ROOM_TYPE,f.COOP_ROOM_TYPE,f.FARM_ROOM_TYPE])}init(){super.init(),this.pen(this.drawParameters,1),this.forever(this.control()),this.onReady(()=>{this.createShopRooms()}),this.addSound("public/sounds/buy_room.mp3","buy")}createShopRooms(){let e=0,s=100,r=340;for(const n of this.rooms){const h=this.gameState.roomsConfig[n],a=new Gt(this,5,[h.shopImage]);a.minSize=200,a.maxSize=210,a.x=s,a.y=r,a.onClick(()=>{this.createRoom(n,h.cost)}),a.pen((u,l)=>{u.font="16px Arial",u.fillStyle="white",u.textAlign="start",u.fillText(h.name,l.x-35,l.y-25),u.fillText(h.cost,l.x-30,l.y+35)}),s+=100,e++,e%3===0&&(s=100,r+=100)}}createRoom(e,s){if(this.gameState.money<s)return showModal("Недостаточно денег",()=>this.stop(),()=>this.run()),!1;if(this.gameState.buy(s)){const r=this.thumbnail.x,n=this.thumbnail.y,h=this.monitorStage.createRoom(e,r,n);this.gameState.deleteRoom(this),this.gameState.addRoom(h),this.thumbnail.delete(),this.playSound("buy"),setTimeout(()=>{this.game.stop(),this.game.run(D.getInstance())},100)}}control(){return()=>{}}getRoomType(){return f.EMPTY_ROOM_TYPE}roomTick(){}drawParameters(e,s){super.drawParameters(e),e.fillStyle="rgba(0, 0, 0, 0.2)",e.fillRect(50,250,500,300),e.font="20px Arial",e.fillStyle="white",e.textAlign="start",e.fillText("Выберите комнату:",65,280)}drawHelp(e){super.drawHelp(e)}}const H=class H extends q{constructor(){super(...arguments);o(this,"inProgress",!1);o(this,"currentProgress",0);o(this,"currentReadyProgress",0);o(this,"tickMaxCount",0);o(this,"foodConsumption",.25)}init(){super.init(),this.forever(this.control()),this.pen(this.drawParameters,4),this.moveButton=new A(this,5),this.moveButton.x=160,this.moveButton.y=490,this.moveButton.onReady(()=>{this.moveButton.setLabel("Куриц в загон",void 0,70)}),this.moveButton.onClick(()=>{for(let e=0;e<this.gameState.rooms.length;e++)if(this.gameState.rooms[e].getRoomType()===f.COOP_ROOM_TYPE){const s=this.gameState.rooms[e];if(s.currentQuantity!=s.maxQuantity){if(s.maxQuantity-s.currentQuantity<this.currentQuantity){s.currentQuantity+=s.maxQuantity-s.currentQuantity,this.currentQuantity-=s.maxQuantity-s.currentQuantity;continue}else s.currentQuantity+=this.currentQuantity;return this.failRoom(),!0}}return showModal("Недостаточно места в стаде, не всех куриц удалось перевести",()=>this.stop(),()=>this.run()),this.failRoom(),!1})}control(){return()=>{this.isRoomReady?this.moveButton.hidden=!1:this.moveButton.hidden=!0}}getRoomType(){return f.NURSERY_ROOM_TYPE}resetRoom(){super.resetRoom(),this.inProgress=!1,this.currentProgress=0,this.currentReadyProgress=0}failRoom(){this.inProgress=!1,this.currentProgress=0,this.currentReadyProgress=0,this.currentQuantity=0,this.isRoomReady=!1,this.visualizerSpawn()}roomTick(){if(super.roomTick(),this.gameState.food>=this.currentQuantity*this.foodConsumption/5)this.gameState.food-=this.currentQuantity*this.foodConsumption/5;else{const e=this.currentQuantity-Math.floor(this.gameState.food*(1/this.foodConsumption));this.currentQuantity=Math.floor(this.gameState.food*(1/this.foodConsumption)+.95*e),this.visualizerSpawn(),this.gameState.food=0,this.currentQuantity<=0&&this.failRoom()}if(this.inProgress){if(this.tickCount+=1,this.tickCount>this.tickMaxCount){this.tickCount=0,this.pollution+=Math.floor(.3*this.currentQuantity);let e=this.pollution>=100?.75:1;this.currentProgress+=e,this.currentProgress>=H.NURSERY_CYCLE_TIMER&&(this.currentProgress=H.NURSERY_CYCLE_TIMER,this.isRoomReady||this.playSound("ready",.5),this.isRoomReady=!0)}this.isRoomReady&&(this.currentReadyProgress+=1,this.currentReadyProgress>H.NURSERY_READY_LIMIT&&(this.pollution+=Math.round(this.currentQuantity*.4))),this.pollution=Math.min(this.pollution,100)}}drawParameters(e,s){super.drawParameters(e),e.font="16px Arial",e.fillStyle="white",e.textAlign="start",e.fillText("Сколько цыплят: "+s.currentQuantity+" шт.",610,190),e.fillText("Вместимость: "+s.maxQuantity+" шт.",610,215),e.fillText("Загрязненность: "+s.pollution+"%",610,240),e.fillText("Готовность: "+s.currentProgress/H.NURSERY_CYCLE_TIMER*100+"%",610,265)}setVisCostumes(){super.setVisCostumes(),this.visualiser.addCostume("public/images/sprites/small_chicken/small_chicken_1.png"),this.visualiser.addCostume("public/images/sprites/small_chicken/small_chicken_2.png")}drawHelp(e){super.drawHelp(e)}};o(H,"NURSERY_CYCLE_TIMER",10),o(H,"NURSERY_READY_LIMIT",10);let Et=H;class fe extends q{constructor(){super(...arguments);o(this,"eggsAmount",0);o(this,"maxEggsAmount",50);o(this,"foodConsumption",.5);o(this,"maxQuantity",50);o(this,"comfortQuantity",40)}init(){super.init(),this.forever(this.control()),this.pen(this.drawParameters,4),this.harvestButton=new A(this,5),this.harvestButton.x=160,this.harvestButton.y=490,this.harvestButton.onReady(()=>{this.harvestButton.setLabel("Собрать яйца",void 0)}),this.harvestButton.onClick(()=>{for(let e=0;e<this.gameState.rooms.length;e++)if(this.gameState.rooms[e].getRoomType()===f.SORTING_ROOM_TYPE){const s=this.gameState.rooms[e];if(s.currentQuantity!=s.maxQuantity){if(s.maxQuantity-s.currentQuantity<this.eggsAmount){s.currentQuantity+=s.maxQuantity-s.currentQuantity,this.eggsAmount-=s.maxQuantity-s.currentQuantity;continue}else s.currentQuantity+=this.eggsAmount,this.eggsAmount=0;return!0}}return showModal("Недостаточно места в сортировке, не все яйца удалось перенести",()=>this.stop(),()=>this.run()),!1})}control(){return()=>{this.eggsAmount>0?this.harvestButton.hidden=!1:this.harvestButton.hidden=!0}}getRoomType(){return f.COOP_ROOM_TYPE}roomTick(){if(super.roomTick(),this.gameState.food>=this.currentQuantity*this.foodConsumption/5)this.gameState.food-=this.currentQuantity*this.foodConsumption/5;else{const e=this.currentQuantity-Math.floor(this.gameState.food*(1/this.foodConsumption));this.currentQuantity=Math.floor(this.gameState.food*(1/this.foodConsumption)+.95*e),this.gameState.food=0,this.visualizerSpawn()}if(this.isRoomReady=!1,this.tickCount+=1,this.tickCount>this.tickMaxCount){this.tickCount=0,this.pollution+=Math.floor(.7*this.currentQuantity);let e=.8*this.pollution>50?this.pollution>=100?.4:.75:1;this.eggsAmount+=Math.round(this.currentQuantity*e),this.currentQuantity=Math.floor(this.currentQuantity*.95),this.eggsAmount>this.maxEggsAmount&&(this.eggsAmount=this.maxEggsAmount,this.isRoomReady=!0),this.pollution=Math.min(this.pollution,100)}}drawParameters(e,s){super.drawParameters(e),e.font="16px Arial",e.fillStyle="white",e.textAlign="start",e.fillText("Сколько куриц: "+s.currentQuantity+" шт.",610,190),e.fillText("Макс. кол-во: "+s.maxQuantity+" шт.",610,215),e.fillText("Комфорт. кол-во: "+s.comfortQuantity+" шт.",610,240),e.fillText("Сколько яиц: "+s.eggsAmount+" шт.",610,265),e.fillText("Макс. яиц: "+s.maxEggsAmount+" шт.",610,290),e.fillText("Загрязненность: "+s.pollution+"%",610,315)}setVisCostumes(){super.setVisCostumes(),this.visualiser.addCostume("public/images/sprites/chicken/chicken_1.png"),this.visualiser.addCostume("public/images/sprites/chicken/chicken_2.png"),this.visualiser.addCostume("public/images/sprites/chicken/chicken_3.png")}drawHelp(e){super.drawHelp(e)}}class ye extends q{constructor(){super(...arguments);o(this,"maxQuantity",100)}init(){super.init(),this.harvestButton=new A(this,5),this.harvestButton.x=160,this.harvestButton.y=490,this.harvestButton.onReady(()=>{this.harvestButton.setLabel("Собрать урожай",void 0,65)}),this.harvestButton.onClick(()=>{this.gameState.food+=this.currentQuantity,this.currentQuantity=0}),this.pen(this.drawParameters,5),this.forever(this.control())}control(){return()=>{this.isRoomReady?this.harvestButton.hidden=!1:this.harvestButton.hidden=!0}}getRoomType(){return f.FARM_ROOM_TYPE}roomTick(){this.tickCount+=1,this.tickCount>this.tickMaxCount&&(this.tickCount=0,this.gameState.manure>10&&this.gameState.eggshell>5&&(this.gameState.manure-=10,this.gameState.eggshell-=5,this.currentQuantity+=30)),this.currentQuantity>0?this.isRoomReady=!0:this.isRoomReady=!1,this.pollution=Math.min(this.pollution,100)}drawParameters(e,s){super.drawParameters(e),e.font="16px Arial",e.fillStyle="white",e.textAlign="start",e.fillText("Урожай: "+s.currentQuantity+" шт.",610,190),e.fillText("Вместимость: "+s.maxQuantity+" шт.",610,215)}drawHelp(e){super.drawHelp(e)}}class Ot{static build(t){const e=Ot.getRoomByType(t);return e.isFirstUse=!0,e}static getRoomByType(t){switch(t){case f.EMPTY_ROOM_TYPE:return new _e;case f.SORTING_ROOM_TYPE:return new pe;case f.INCUBATOR_ROOM_TYPE:return new bt;case f.NURSERY_ROOM_TYPE:return new Et;case f.COOP_ROOM_TYPE:return new fe;case f.FARM_ROOM_TYPE:return new ye}return null}}class Ce extends Wt{constructor(){super(...arguments);o(this,"minSize",18);o(this,"maxSize",20)}init(){this.addCostume("public/images/icons/space_progress/ship_1.png"),super.init()}}class Se extends v{constructor(){super(...arguments);o(this,"lessColor","red");o(this,"moreColor","green");o(this,"textColor","white");o(this,"valueColor","gold");o(this,"targetValue",0);o(this,"currentValue",0);o(this,"minValue",0);o(this,"maxValue",100);o(this,"minX",0);o(this,"maxX",0)}init(){this.forever(this.control),this.pen(this.drawProgress.bind(this),10),this.pen(this.setLabel.bind(this),11)}control(){this.currentValue>this.maxValue&&(this.currentValue=this.maxValue),this.currentValue<this.minValue&&(this.currentValue=this.minValue),this.targetValue>this.maxValue&&(this.targetValue=this.maxValue),this.targetValue<this.minValue&&(this.targetValue=this.minValue),this.targetValue>this.currentValue&&(this.currentValue+=Math.ceil((this.targetValue-this.currentValue)/10)),this.targetValue<this.currentValue&&(this.currentValue+=Math.floor((this.targetValue-this.currentValue)/10))}drawProgress(e){e.fillStyle=this.valueColor,e.fillRect(this.minX,this.y-10,(this.maxX-this.minX)*(this.currentValue/this.maxValue),20),this.targetValue>this.currentValue?e.fillStyle=this.moreColor:e.fillStyle=this.lessColor,e.fillRect(this.minX+(this.maxX-this.minX)*(this.currentValue/this.maxValue),this.y-10,(this.maxX-this.minX)*((this.targetValue-this.currentValue)/this.maxValue),20)}setLabel(e){this.touchMouse()&&(e.font="10px Arial",e.fillStyle=this.textColor,e.textAlign="center",e.fillText(this.currentValue,this.x,this.y+3))}setWidth(e){this.minX=this.x-e/2,this.maxX=this.x+e/2,this.setRectCollider("name",e,20)}}class be extends Se{control(){super.control(),this.game.keyPressed("d")&&(this.targetValue+=5),this.game.keyPressed("a")&&(this.targetValue-=5)}}const G=class G extends Mt{constructor(){super();o(this,"textBlockHeight",160);o(this,"successSlides",[{text:"Ваш космический птицеводческий комплекс успешно доставил жизненно важный груз яиц на целевые планеты. Благодаря вашему грамотному управлению и своевременному выполнению всех производственных циклов, тысячи свежих яиц пополнили продовольственные запасы колонистов."},{text:'Признание Галактического Совета не заставило себя ждать - ваша птицефабрика получила статус "Образцовое предприятие космического сельского хозяйства". Технологии, отработанные вами в ходе миссии, станут эталоном для создания подобных комплексов на новых планетах.'},{text:"Новые горизонты открываются перед вашим предприятием. Успешное завершение миссии привлекло внимание инвесторов и научных организаций. Теперь вам предстоит масштабировать производство, внедрять новые технологии и, возможно, заняться разведением других видов сельскохозяйственных животных в условиях космоса."}]);o(this,"failSlides",[{text:"Плохая концовка, сообщение 1."},{text:"Плохая концовка, сообщение 2."},{text:"Плохая концовка, сообщение 3."}]);if(G.instance)throw new Error("OutroStage class: use getInstance() method instead.")}static getInstance(){return G.instance||(G.instance=new G),G.instance}init(){super.init(),this.addBackground("public/images/outro/success.jpg"),this.addBackground("public/images/outro/fail.jpg"),this.startButton=new A,this.startButton.layer=4,this.startButton.minSize=90,this.startButton.maxSize=110,this.startButton.x=80,this.startButton.y=this.height-30,this.startButton.hidden=!0,this.startButton.onClick(this.runGame.bind(this)),this.startButton.onReady(()=>{this.startButton.setLabel("Еще раз","white",70)})}setResult(e){e?(this.slides=this.successSlides,this.switchBackground(0)):(this.slides=this.failSlides,this.switchBackground(1))}onNextSlide(){this.currentSlide===this.slides.length-1&&(this.nextButton.hidden=!0,this.startButton.hidden=!1)}runGame(){D.getInstance().restartGame(),this.game.run(K.getInstance())}};o(G,"instance");let rt=G;const $=class $ extends wt{constructor(e=null){super(e);o(this,"helpText",null);o(this,"helpTextLifetime",0)}static getInstance(){return $.instance||($.instance=new $),$.instance}init(){super.init(),this.gameState=f.getInstance(),this.addBackground("public/images/common/main_monitor.png"),this.addSound("public/sounds/background_music.mp3","background_music"),this.bgShipSprite=new v,this.bgShipSprite.addCostume("public/images/monitor/main_screen.png"),this.bgShipSprite.leftX=300,this.bgShipSprite.setAlpha=.5,this.bgShipSprite.br=0,this.bgShipSprite.time=.9,this.sliderPlanet1=new v,this.sliderPlanet1.addCostume("public/images/icons/space_progress/planet_1.png"),this.sliderPlanet1.x=170,this.sliderPlanet1.y=500,this.sliderPlanet2=new v,this.sliderPlanet2.addCostume("public/images/icons/space_progress/planet_2.png"),this.sliderPlanet2.x=300,this.sliderPlanet2.y=500,this.sliderPlanet3=new v,this.sliderPlanet3.addCostume("public/images/icons/space_progress/planet_3.png"),this.sliderPlanet3.x=420,this.sliderPlanet3.y=500,this.sliderPlanet4=new v,this.sliderPlanet4.addCostume("public/images/icons/space_progress/planet_4.png"),this.sliderPlanet4.x=515,this.sliderPlanet4.y=505,this.sliderPlanet4.size=200,this.game.onUserInteracted(()=>{this.playSound("background_music",{loop:!0})}),this.progressSlider=new Ce,this.progressSlider.x=290,this.progressSlider.y=500,this.progressSlider.size=100,this.progressSlider.layer=4,this.progressSlider.currentValue=50,this.progressSlider.lessColor="red",this.progressSlider.moreColor="red",this.progressSlider.setWidth(470),this.progressSlider.canMove=!1,this.progressSlider.drawLine=!1,this.progressSlider.drawValue=!1,this.progressSlider.maxValue=f.getInstance().limitTime,this.readySprite=new v,this.readySprite.addCostume("public/images/icons/room_is_ready.png"),this.readySprite.size=50,this.readySprite.hidden=!0,this.licenceProgress=new be,this.licenceProgress.x=200,this.licenceProgress.y=50,this.licenceProgress.setWidth(60),this.createDrones(6),this.createRooms();const e=new ge(this,1);e.x=550,e.y=455,e.hidden=!1,e.onClick(()=>{const s=this.gameState.getNextEggQualityClass();let r='<table border="0">';const n=this.gameState.getEggQualityInfo();r+='<tr><td style="text-align: left">Категория яйца:</td><td>'+this.gameState.getEggQualityClass()+"</td></tr>",r+='<tr><td style="text-align: left">Стоимость яйца:</td><td>'+this.gameState.getEggQualityCost()+"$</td></tr>",r+='<tr><td colspan="2"><hr></td></tr>',r+='<tr><td style="text-align: left">Порода "'+this.gameState.getChickenBreedName()+'":</td><td>'+this.addPlus(n.chickenBreed)+"</td></tr>",r+='<tr><td style="text-align: left">Условие чистоты:</td><td>'+this.addPlus(n.cleanViolation)+"</td></tr>",r+='<tr><td style="text-align: left">Условие кормления:</td><td>'+this.addPlus(n.feedingViolation)+"</td></tr>",r+='<tr><td style="text-align: left">Условие содержания:</td><td>'+this.addPlus(n.chickenConditionViolation)+"</td></tr>",r+="</table>",r+="<hr>",s&&(r+='<p>Нужно баллов получения следующей категории "'+s+'": '+this.gameState.getEggQualityPoint(s)+"</p>"),this.showModal(r)}),this.forever(this.gameTick,1e3),this.pen(this.drawHelpBlock.bind(this))}addPlus(e){return e>0?"+"+e:e}restartGame(){this.gameState.reset()}drawReadyRooms(){this.readySprite.deleteClones();for(const e of this.gameState.rooms)if(e.isRoomReady){const s=this.readySprite.createClone();s.x=e.thumbnail.x+27,s.y=e.thumbnail.y-16,s.hidden=!1,s.layer=4}}createRooms(){const e=this.gameState.getShipConfig();for(const s of e){const r=this.createRoom(s.type,s.x,s.y);this.gameState.addRoom(r)}}createRoom(e,s,r){const n=Ot.build(e);return ue.build(this,n,s,r),n}createDrones(e){for(let s=0;s<e;s++){const r=new de(this);r.layer=8,r.x=650+s%2*75,r.y=145+Math.floor(s/2)*75,r.setStartPos(),r.hidden=!1,this.gameState.addDrone(r)}}gameTick(){if(this.gameState.currentMission===-1&&(this.showMission(this.gameState.currentMission,!0,null,null,null,"Основная механика игры заключается в управлении пятью производственными отсеками птицефабрики, где каждый модуль требует вашего постоянного внимания. Вам предстоит одновременно следить за инкубацией яиц, выращиванием цыплят, сбором яиц от взрослых кур, производством корма и распределением готовой продукции. Ключевой навык - умение балансировать между этими процессами, не допуская простоев и потерь."),this.gameState.currentMission++),this.gameState.isReadingHelper)return;this.missionProcess(),this.gameState.passedTime+=1,this.gameState.passedTime>=this.gameState.limitTime,this.gameState.chick=0,this.gameState.chicken=0,this.gameState.pollution=0,this.gameState.comfortChickenQuantity=0;let e=0;for(const s of this.gameState.rooms)s.getRoomType()!==f.EMPTY_ROOM_TYPE&&(e++,s.roomTick(),s.getRoomType()===f.NURSERY_ROOM_TYPE&&(this.gameState.chick+=s.currentQuantity),s.getRoomType()===f.COOP_ROOM_TYPE&&(this.gameState.chicken+=s.currentQuantity,this.gameState.comfortChickenQuantity+=s.comfortQuantity),this.gameState.pollution+=s.pollution);this.gameState.pollution=Math.round(this.gameState.pollution/e);for(const s of this.gameState.drones)s.isCharging&&(s.charge+=5);this.violationProcess(),this.eventProcess(),this.gameState.rating<=f.CRITICAL_RATING&&this.showOutro(!1),this.progressSlider.setCurrentValue(this.gameState.passedTime),this.drawReadyRooms()}getFinishMessage(){switch(this.gameState.successfulCompletedMissions){case 0:return"Экипаж, мы потерпели полное фиаско! Ни одна из планет не получила жизненно важные грузы. Наша репутация уничтожена, контракты расторгнуты. Возможно, птицеводство в космосе - не ваше призвание...";case 1:return"Минимальный результат достигнут. Хотя мы смогли помочь только одной колонии, этого явно недостаточно для признания миссии успешной. Галактический Совет рекомендует пройти дополнительное обучение.";case 2:return"Частичный успех! Две планеты получили необходимую помощь, но две другие остались без поддержки. Ваши навыки требуют совершенствования, но потенциал очевиден. Продолжайте работать над собой!";case 3:return"Отличный результат! Три из четырех колоний с благодарностью приняли вашу помощь. Галактический Совет доволен вашей работой и готов рассматривать новые контракты. Вы доказали свою состоятельность!";default:return'Блестящий успех! Все целевые планеты получили грузы в полном объеме. Ваше мастерство управления космической птицефабрикой не имеет равных! Галактический Совет награждает вас званием "Лучший космический аграрий года"!'}}drawParameters(e){super.drawParameters(e),e.font="bold 18px Arial",e.fillStyle="#fff",e.fillText("Дроны-уборщики:",610,100),e.font="18px Arial",e.fillStyle="#a8e2c0ff",e.textAlign="start";const s=this.gameState.currentMission,r=this.gameState.missions[s];r&&(e.fillStyle="#f1f1f1ff",e.fillText("Планета: "+r.name,70,380),e.fillText("Нужно яиц: "+r.eggQuota,70,405),e.fillText("Осталось время: "+(r.distance-this.gameState.passedTime),70,430),e.fillText("Загрязненность: "+this.gameState.pollution+"%",70,455)),e.fillText("Рейтинг: "+this.gameState.rating,320,410),e.fillText("Деньги: "+this.gameState.money+"$",320,435),e.fillText("Качество яйца: "+this.gameState.getEggQualityClass()+" (+"+this.gameState.getEggQualityCost()+"$)",320,460),this.bgShipSprite.time+=.01,this.bgShipSprite.br=Math.sin(this.bgShipSprite.time)*20,this.bgShipSprite.filter="hue-rotate("+this.bgShipSprite.br+"deg) opacity(80%)"}showMission(e,s,r=null,n=null,h=null,a=null,u=null){st.getInstance().setMissionSlides(e,s,r,n,h,a,u),this.game.run(st.getInstance())}showOutro(e){rt.getInstance().setResult(e),this.game.run(rt.getInstance())}showHelp(e,s=10){this.helpText=e,this.helpTextLifetime=s}drawHelpBlock(e){if(this.helpText){if(this.helpTextLifetime--,this.helpTextLifetime<=0){this.helpText=null;return}e.font="bold 18px Arial",e.fillStyle="#a8e2c0ff",e.fillText("Справка:",610,400),e.font="14px Arial",this.drawMultilineText(e,this.helpText,610,430,165,20)}}missionProcess(){const e=this.gameState.currentMission,s=this.gameState.missions[e];if(!s)return;const r=s.distance;if(this.gameState.passedTime>=r){const n=s.eggQuota,h=this.gameState.frozenEggs>=n;h&&(this.gameState.successfulCompletedMissions+=1);const a=h?s.successChangeRating:s.failChangeRating,u=Math.min(this.gameState.frozenEggs,n),l=u*this.gameState.getEggQualityCost();this.gameState.frozenEggs-=u,this.gameState.money+=l,this.gameState.changeRating(a);const c=this.gameState.currentMission===this.gameState.missions.length-1?this.getFinishMessage():null;this.showMission(this.gameState.currentMission,h,u,l,a,null,c),this.gameState.currentMission+=1,this.gameState.resetViolations()}}violationProcess(){!this.gameState.feedingViolation&&this.gameState.food<=f.CRITICAL_FOOD&&(this.gameState.feedingViolation=!0,this.gameState.changeRating(this.gameState.violations.feeding.fail.changeRating),this.showViolationModal("Нарушение кормления","Еда закончилась. Курицы и цыплята постепенно умирают")),!this.gameState.cleanViolation&&this.gameState.pollution>=f.CRITICAL_POLLUTION&&(this.gameState.cleanViolation=!0,this.gameState.changeRating(this.gameState.violations.clean.fail.changeRating),this.showViolationModal("Нарушение чистоты","Слишком грязно, мы теряем качество")),!this.gameState.conditionViolation&&this.gameState.chicken>this.gameState.comfortChickenQuantity&&(this.gameState.conditionViolation=!0,this.gameState.changeRating(this.gameState.violations.condition.fail.changeRating),this.showViolationModal("Нарушение условий содержания","Курицам слишком тесно, мы теряем качество"))}eventProcess(){if(this.gameState.eventTimer++,this.gameState.eventTimer<f.EVENT_TIMER_MIN||this.gameState.eventAnswers.length>=this.gameState.events.length)return;if(this.game.getRandom(0,f.EVENT_TIMER_MAX)<this.gameState.eventTimer){const s=this.gameState.getRandomEventId();this.showEventModal(s,r=>{const n=this.gameState.events[s],h=n.variants[r].correct,a=n.variants[r].changeRating,u=n.variants[r].comment;if(this.gameState.eventAnswers.push({event:s,variant:r}),this.gameState.changeRating(a),h){let l="<h2>Молодец! Правильно!</h2>";l+="<p>"+u+"</p>",l+="<p>Рейтинг изменился на: +"+a+"</p>",this.showModal(l)}else{const l=this.gameState.getEventCorrectAnswer(s);let c="<h2>Ответ неправильный</h2>";c+="<p>"+u+"</p>",c+="<p>Правильный ответ: "+l+"</p>",c+="<p>Рейтинг изменился на: "+a+"</p>",this.showModal(c)}}),this.gameState.eventTimer=0}}showModal(e){showModal(e,()=>this.game.getActiveStage().stop(),()=>this.game.getActiveStage().run())}showViolationModal(e,s){let r="<h2>"+e+"</h2>";r+="<p>"+s+"</p>",this.showModal(r)}showEventModal(e,s){const r=this.gameState.events[e],n=r.name,h=r.description,a=r.question,u=r.image,l=r.variants.map(d=>d.answer);let c="<p>"+h+"</p>";c+="<p><strong>"+a+"</strong></p>",showEventModal(n,c,u,l,()=>this.game.getActiveStage().stop(),d=>{this.game.getActiveStage().run(),s(d)})}};o($,"instance");let D=$;const W=class W extends Mt{constructor(){super();o(this,"slides",[{text:"Что появилось первым, яйцо или курица?..."},{text:"Извечный вопрос без ответа. Но для вас ответ есть..."},{text:"это.."},{text:"ЯЙЦО!"},{text:"Да, вот так всё странно.. Смиритесь с этим, прочтите лор игры и сразу всё поймёте!"},{text:"2451 год, корпорация ТАВРОС отправляет груз с замороженными яйцами на Альфа-Центавра Проксима-b. "},{text:"На пути есть еще четые планеты, в которые нужно доставить груз "},{text:"Через 15 лет космический грузовик сталкивается с астероидом и часть груза оказывается поврежденным..."},{text:"Чтобы выполнить миссию, системы корабля оживают и были приспособлены восстановить популяцию куриц."},{text:"Затем вам нужно замораживать яйца и пополнять склады корабля, чтобы выполнить квоты заказчика."},{text:"Ваша задача, управляя удаленно базовым функционалом систем корабля, восстановить груз до прилета к цели..."},{text:"И да, удачи, инженер!"}]);if(W.instance)throw new Error("IntroStage class: use getInstance() method instead.")}static getInstance(){return W.instance||(W.instance=new W),W.instance}init(){super.init(),this.addBackground("public/images/intro/background.jpg"),this.startButton=new A,this.startButton.layer=4,this.startButton.minSize=90,this.startButton.maxSize=110,this.startButton.x=this.width-80,this.startButton.y=this.height-30,this.startButton.hidden=!0,this.startButton.onClick(this.runGame.bind(this)),this.startButton.onReady(()=>{this.startButton.setLabel("Играть")})}onNextSlide(){this.currentSlide===this.slides.length-1&&(this.nextButton.hidden=!0,this.startButton.hidden=!1)}runGame(){this.reset(),this.game.run(D.getInstance())}};o(W,"instance");let gt=W;const j=class j extends Ht{static getInstance(){return j.instance||(j.instance=new j),j.instance}init(){vt.create(0,"public/images/menu/layer_1.jpg");const t=new A;t.layer=4,t.onReady(()=>{t.setLabel("Играть")}),t.onClick(()=>{this.game.run(gt.getInstance())})}};o(j,"instance");let K=j;const At=new tt(800,600,null,!1);At.context.imageSmoothingEnabled=!1;At.showFps=!0;K.getInstance();gt.getInstance();st.getInstance();rt.getInstance();D.getInstance();At.run(K.getInstance());
